<%- include('../layout', { body: `
<div class="max-w-7xl mx-auto">
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      <i class="fas fa-money-bill-wave text-primary-500"></i>
      Pago a Laboratorio
    </h1>
    <p class="text-gray-600 mt-1">Gestiona servicios y pagos de laboratorios</p>
  </div>

  <!-- Pestañas -->
  <div class="bg-white rounded-xl shadow-sm mb-6">
    <div class="border-b border-gray-200">
      <nav class="flex">
        <button onclick="mostrarTab('paciente')" id="tabPaciente" 
          class="px-6 py-4 font-medium text-sm border-b-2 border-primary-500 text-primary-600">
          <i class="fas fa-user mr-2"></i>Buscar por Paciente
        </button>
        <button onclick="mostrarTab('laboratorio')" id="tabLaboratorio"
          class="px-6 py-4 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
          <i class="fas fa-flask mr-2"></i>Buscar por Laboratorio
        </button>
      </nav>
    </div>

    <!-- Contenido: Búsqueda por Paciente -->
    <div id="contenidoPaciente" class="p-6">
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Buscar Paciente
        </label>
        <div style="position: relative;">
          <input type="hidden" id="pacienteBuscarId">
          <input type="text" id="pacienteBuscar_search" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
            placeholder="Buscar paciente por nombre o apellido..." autocomplete="off">
        </div>
      </div>

      <div id="resultadosPaciente" class="hidden">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Servicios de Laboratorio</h3>
        <div id="listaServiciosPaciente" class="space-y-4"></div>
      </div>

      <div id="sinServiciosPaciente" class="hidden text-center py-8 text-gray-500">
        <i class="fas fa-info-circle text-4xl mb-4"></i>
        <p class="text-lg">Este paciente no tiene servicios de laboratorio asignados.</p>
        <p class="text-sm mt-2">Puedes asignar servicios desde la pestaña "+ Servicio de Laboratorio" en el menú.</p>
      </div>
    </div>

    <!-- Contenido: Búsqueda por Laboratorio -->
    <div id="contenidoLaboratorio" class="p-6 hidden">
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Seleccionar Laboratorio
        </label>
        <select id="laboratorioBuscar" 
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
          <option value="">Seleccionar laboratorio</option>
          ${laboratorios.map(function(l) {
            return '<option value="' + l.id + '">' + l.nombre + '</option>';
          }).join('')}
        </select>
      </div>

      <div id="resultadosLaboratorio" class="hidden">
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-600">Total Deuda:</p>
              <p id="totalDeuda" class="text-2xl font-bold text-red-600">$0.00</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Total Pagado:</p>
              <p id="totalPagado" class="text-2xl font-bold text-green-600">$0.00</p>
            </div>
          </div>
        </div>
        <h3 class="text-lg font-bold text-gray-800 mb-4">Servicios Pendientes</h3>
        <div id="listaServiciosLaboratorio" class="space-y-4"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Registrar Pago -->
<div id="modalPago" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4">
    <div class="p-6 border-b">
      <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
        <i class="fas fa-money-bill-wave text-primary-500"></i>
        Registrar Pago
      </h3>
    </div>
    <div class="p-6">
      <form id="formPago" onsubmit="registrarPago(event)">
        <input type="hidden" id="servicioLaboratorioIdPago">
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Paciente</label>
          <input type="text" id="pacienteNombrePago" readonly
            class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Saldo Pendiente
          </label>
          <input type="text" id="saldoPendientePago" readonly
            class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-lg font-bold text-red-600">
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Monto del Pago <span class="text-red-500">*</span>
          </label>
          <input type="number" id="montoPago" step="0.01" min="0.01" required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
            placeholder="0.00">
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Método de Pago <span class="text-red-500">*</span>
          </label>
          <select id="metodoPagoPago" required onchange="mostrarBancoPago()"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
            <option value="">Seleccionar método</option>
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta">Tarjeta</option>
            <option value="transferencia">Transferencia</option>
          </select>
        </div>

        <div id="bancoContainerPago" class="mb-4 hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Banco <span class="text-red-500">*</span>
          </label>
          <select id="bancoPago"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
            <option value="">Seleccionar banco</option>
            <option value="Azteca">Azteca</option>
            <option value="BBVA">BBVA</option>
            <option value="Mercado Pago">Mercado Pago</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Observaciones</label>
          <textarea id="observacionesPago" rows="3"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
            placeholder="Notas adicionales (opcional)"></textarea>
        </div>

        <div class="flex gap-4">
          <button type="button" onclick="cerrarModalPago()"
            class="flex-1 px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
            Cancelar
          </button>
          <button type="submit"
            class="flex-1 bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700 transition">
            <i class="fas fa-save mr-2"></i>Registrar Pago
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Error -->
<div id="modalError" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
    <div class="p-6">
      <div class="flex items-center justify-center mb-4">
        <div class="bg-red-100 rounded-full p-4">
          <i class="fas fa-exclamation-circle text-red-600 text-4xl"></i>
        </div>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 text-center mb-2">Error</h3>
      <p id="mensajeError" class="text-gray-600 text-center mb-6"></p>
      <div class="flex justify-center">
        <button onclick="cerrarModalError()" 
          class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg font-medium transition shadow-lg">
          <i class="fas fa-check mr-2"></i>Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Éxito -->
<div id="modalExito" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
    <div class="p-6">
      <div class="flex items-center justify-center mb-4">
        <div class="bg-green-100 rounded-full p-4">
          <i class="fas fa-check-circle text-green-600 text-4xl"></i>
        </div>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 text-center mb-2">¡Éxito!</h3>
      <p id="mensajeExito" class="text-gray-600 text-center mb-6"></p>
      <div class="flex justify-center">
        <button onclick="cerrarModalExito()" 
          class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition shadow-lg">
          <i class="fas fa-check mr-2"></i>Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Preparar datos para búsqueda de pacientes
const pacientesDataJsonStr = JSON.stringify([]);

let tabActual = 'paciente';

function mostrarTab(tab) {
  tabActual = tab;
  
  // Actualizar pestañas
  document.getElementById('tabPaciente').classList.remove('border-primary-500', 'text-primary-600');
  document.getElementById('tabPaciente').classList.add('border-transparent', 'text-gray-500');
  document.getElementById('tabLaboratorio').classList.remove('border-primary-500', 'text-primary-600');
  document.getElementById('tabLaboratorio').classList.add('border-transparent', 'text-gray-500');
  
  if (tab === 'paciente') {
    document.getElementById('tabPaciente').classList.add('border-primary-500', 'text-primary-600');
    document.getElementById('tabPaciente').classList.remove('border-transparent', 'text-gray-500');
    document.getElementById('contenidoPaciente').classList.remove('hidden');
    document.getElementById('contenidoLaboratorio').classList.add('hidden');
  } else {
    document.getElementById('tabLaboratorio').classList.add('border-primary-500', 'text-primary-600');
    document.getElementById('tabLaboratorio').classList.remove('border-transparent', 'text-gray-500');
    document.getElementById('contenidoPaciente').classList.add('hidden');
    document.getElementById('contenidoLaboratorio').classList.remove('hidden');
  }
}

function mostrarBancoPago() {
  const metodoPago = document.getElementById('metodoPagoPago').value;
  const bancoContainer = document.getElementById('bancoContainerPago');
  
  if (metodoPago === 'tarjeta' || metodoPago === 'transferencia') {
    bancoContainer.classList.remove('hidden');
    document.getElementById('bancoPago').required = true;
  } else {
    bancoContainer.classList.add('hidden');
    document.getElementById('bancoPago').required = false;
    document.getElementById('bancoPago').value = '';
  }
}

function abrirModalPago(servicioId, pacienteNombre, saldoPendiente) {
  document.getElementById('servicioLaboratorioIdPago').value = servicioId;
  document.getElementById('pacienteNombrePago').value = pacienteNombre;
  document.getElementById('saldoPendientePago').value = '$' + parseFloat(saldoPendiente).toFixed(2);
  document.getElementById('montoPago').value = '';
  document.getElementById('montoPago').max = saldoPendiente;
  document.getElementById('metodoPagoPago').value = '';
  document.getElementById('bancoPago').value = '';
  document.getElementById('observacionesPago').value = '';
  mostrarBancoPago();
  document.getElementById('modalPago').classList.remove('hidden');
}

function cerrarModalPago() {
  document.getElementById('modalPago').classList.add('hidden');
}

function mostrarModalError(mensaje) {
  document.getElementById('mensajeError').textContent = mensaje;
  document.getElementById('modalError').classList.remove('hidden');
}

function cerrarModalError() {
  document.getElementById('modalError').classList.add('hidden');
}

function mostrarModalExito(mensaje) {
  document.getElementById('mensajeExito').textContent = mensaje;
  document.getElementById('modalExito').classList.remove('hidden');
}

function cerrarModalExito() {
  document.getElementById('modalExito').classList.add('hidden');
}

// Cerrar modales al hacer clic fuera de ellos
document.addEventListener('DOMContentLoaded', function() {
  const modalError = document.getElementById('modalError');
  const modalExito = document.getElementById('modalExito');
  
  if (modalError) {
    modalError.addEventListener('click', function(e) {
      if (e.target === modalError) {
        cerrarModalError();
      }
    });
  }
  
  if (modalExito) {
    modalExito.addEventListener('click', function(e) {
      if (e.target === modalExito) {
        cerrarModalExito();
      }
    });
  }
});

async function registrarPago(event) {
  event.preventDefault();
  
  const servicioLaboratorioId = document.getElementById('servicioLaboratorioIdPago').value;
  const monto = document.getElementById('montoPago').value;
  const metodoPago = document.getElementById('metodoPagoPago').value;
  const banco = document.getElementById('bancoPago').value;
  const observaciones = document.getElementById('observacionesPago').value;
  
  if ((metodoPago === 'tarjeta' || metodoPago === 'transferencia') && !banco) {
    mostrarModalError('Debe seleccionar un banco para este método de pago');
    return;
  }
  
  try {
    const response = await fetch('/laboratorios/api/registrar-pago', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        servicioLaboratorioId,
        monto,
        metodoPago,
        banco: banco || null,
        observaciones: observaciones || null,
      }),
    });
    
    const data = await response.json();
    
    if (data.success) {
      cerrarModalPago();
      mostrarModalExito('Pago registrado correctamente');
      // Recargar resultados después de cerrar el modal de éxito
      setTimeout(function() {
        if (tabActual === 'paciente') {
          const pacienteId = document.getElementById('pacienteBuscarId').value;
          if (pacienteId) buscarPorPaciente(pacienteId);
        } else {
          const laboratorioId = document.getElementById('laboratorioBuscar').value;
          if (laboratorioId) buscarPorLaboratorio(laboratorioId);
        }
      }, 500);
    } else {
      mostrarModalError(data.error || 'Error al registrar el pago');
    }
  } catch (error) {
    console.error('Error al registrar pago:', error);
    mostrarModalError('Error al registrar el pago. Por favor, intente nuevamente.');
  }
}

async function buscarPorPaciente(pacienteId) {
  try {
    const response = await fetch('/laboratorios/api/buscar-paciente/' + pacienteId);
    const data = await response.json();
    
    if (data.success) {
      const servicios = data.servicios;
      const lista = document.getElementById('listaServiciosPaciente');
      const resultados = document.getElementById('resultadosPaciente');
      const sinServicios = document.getElementById('sinServiciosPaciente');
      
      if (servicios.length === 0) {
        resultados.classList.add('hidden');
        sinServicios.classList.remove('hidden');
        return;
      }
      
      resultados.classList.remove('hidden');
      sinServicios.classList.add('hidden');
      
      lista.innerHTML = servicios.map(function(s) {
        const estadoColor = s.estado === 'pagado' ? 'green' : s.estado === 'cancelado' ? 'red' : 'yellow';
        const estadoText = s.estado === 'pagado' ? 'Pagado' : s.estado === 'cancelado' ? 'Cancelado' : 'Pendiente';
        const puedePagar = s.estado === 'pendiente' && parseFloat(s.saldoPendiente) > 0;
        
        return '<div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition">' +
          '<div class="flex justify-between items-start mb-2">' +
            '<div>' +
              '<h4 class="font-bold text-gray-800">' + s.servicio.nombre + '</h4>' +
              '<p class="text-sm text-gray-600">Laboratorio: ' + s.laboratorio.nombre + '</p>' +
              '<p class="text-sm text-gray-600">Doctor: Dr. ' + s.doctor.nombre + ' ' + s.doctor.apellido + '</p>' +
            '</div>' +
            '<span class="px-3 py-1 rounded-full text-xs font-medium bg-' + estadoColor + '-100 text-' + estadoColor + '-800">' + estadoText + '</span>' +
          '</div>' +
          '<div class="grid md:grid-cols-3 gap-4 mt-4 pt-4 border-t border-gray-200">' +
            '<div><p class="text-xs text-gray-600">Costo Total</p><p class="font-bold text-gray-800">$' + parseFloat(s.costo).toFixed(2) + '</p></div>' +
            '<div><p class="text-xs text-gray-600">Pagado</p><p class="font-bold text-green-600">$' + parseFloat(s.montoPagado).toFixed(2) + '</p></div>' +
            '<div><p class="text-xs text-gray-600">Saldo Pendiente</p><p class="font-bold text-red-600">$' + parseFloat(s.saldoPendiente).toFixed(2) + '</p></div>' +
          '</div>' +
          (puedePagar ? '<div class="mt-4 pt-4 border-t border-gray-200">' +
            '<button onclick="abrirModalPago(' + s.id + ', \\'' + s.paciente.nombre + ' ' + s.paciente.apellido + '\\', ' + s.saldoPendiente + ')" ' +
            'class="w-full bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition">' +
            '<i class="fas fa-money-bill-wave mr-2"></i>Registrar Pago' +
            '</button>' +
          '</div>' : '') +
        '</div>';
      }).join('');
    }
  } catch (error) {
    console.error('Error al buscar por paciente:', error);
    mostrarModalError('Error al buscar servicios. Por favor, intente nuevamente.');
  }
}

async function buscarPorLaboratorio(laboratorioId) {
  try {
    const response = await fetch('/laboratorios/api/buscar-laboratorio/' + laboratorioId);
    const data = await response.json();
    
    if (data.success) {
      const servicios = data.servicios;
      const lista = document.getElementById('listaServiciosLaboratorio');
      const resultados = document.getElementById('resultadosLaboratorio');
      
      document.getElementById('totalDeuda').textContent = '$' + parseFloat(data.totales.deuda).toFixed(2);
      document.getElementById('totalPagado').textContent = '$' + parseFloat(data.totales.pagado).toFixed(2);
      
      resultados.classList.remove('hidden');
      
      lista.innerHTML = servicios.map(function(s) {
        const puedePagar = s.estado === 'pendiente' && parseFloat(s.saldoPendiente) > 0;
        
        return '<div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition">' +
          '<div class="flex justify-between items-start mb-2">' +
            '<div class="flex-1">' +
              '<h4 class="font-bold text-gray-800">' + s.servicio.nombre + '</h4>' +
              '<p class="text-sm text-gray-600">Paciente: ' + s.paciente.nombre + ' ' + s.paciente.apellido + '</p>' +
              '<p class="text-sm text-gray-600">Doctor: Dr. ' + s.doctor.nombre + ' ' + s.doctor.apellido + '</p>' +
            '</div>' +
          '</div>' +
          '<div class="grid md:grid-cols-3 gap-4 mt-4 pt-4 border-t border-gray-200">' +
            '<div><p class="text-xs text-gray-600">Costo Total</p><p class="font-bold text-gray-800">$' + parseFloat(s.costo).toFixed(2) + '</p></div>' +
            '<div><p class="text-xs text-gray-600">Pagado</p><p class="font-bold text-green-600">$' + parseFloat(s.montoPagado).toFixed(2) + '</p></div>' +
            '<div><p class="text-xs text-gray-600">Saldo Pendiente</p><p class="font-bold text-red-600">$' + parseFloat(s.saldoPendiente).toFixed(2) + '</p></div>' +
          '</div>' +
          (puedePagar ? '<div class="mt-4 pt-4 border-t border-gray-200">' +
            '<button onclick="abrirModalPago(' + s.id + ', \\'' + s.paciente.nombre + ' ' + s.paciente.apellido + '\\', ' + s.saldoPendiente + ')" ' +
            'class="w-full bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition">' +
            '<i class="fas fa-money-bill-wave mr-2"></i>Registrar Pago' +
            '</button>' +
          '</div>' : '') +
        '</div>';
      }).join('');
    }
  } catch (error) {
    console.error('Error al buscar por laboratorio:', error);
    mostrarModalError('Error al buscar servicios. Por favor, intente nuevamente.');
  }
}

// Inicializar componentes
(function() {
  const pacientesData = [];
  
  function inicializar() {
    if (typeof window.createSearchableSelect === 'undefined') {
      setTimeout(inicializar, 100);
      return;
    }
    
    // Componente de búsqueda para paciente (solo con deuda pendiente)
    const pacienteInput = document.getElementById('pacienteBuscar_search');
    const pacienteHiddenInput = document.getElementById('pacienteBuscarId');
    
    if (pacienteInput) {
      let pacientesDataCache = [];
      let resultadosContainer = null;
      
      // Crear contenedor de resultados si no existe
      resultadosContainer = document.getElementById('pacienteBuscar_search_results');
      if (!resultadosContainer) {
        resultadosContainer = document.createElement('div');
        resultadosContainer.id = 'pacienteBuscar_search_results';
        resultadosContainer.className = 'absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden';
        pacienteInput.parentElement.style.position = 'relative';
        pacienteInput.parentElement.appendChild(resultadosContainer);
      }
      
      // Función para buscar y mostrar pacientes
      function buscarYMostrarPacientes(query) {
        fetch('/laboratorios/api/buscar-pacientes-deuda?q=' + encodeURIComponent(query || ''))
          .then(function(res) { return res.json(); })
          .then(function(pacientes) {
            pacientesDataCache = pacientes;
            mostrarResultadosPacientes(query);
          })
          .catch(function(error) {
            console.error('Error al buscar pacientes:', error);
            resultadosContainer.innerHTML = '<div class="p-3 text-gray-500 text-sm text-center">Error al buscar pacientes</div>';
            resultadosContainer.classList.remove('hidden');
          });
      }
      
      // Función para mostrar resultados
      function mostrarResultadosPacientes(searchTerm) {
        const term = (searchTerm || '').toLowerCase().trim();
        let filtered = [];
        if (term === '') {
          filtered = pacientesDataCache;
        } else {
          filtered = pacientesDataCache.filter(function(p) {
            const text = (p.text || (p.nombre + ' ' + p.apellido)).toLowerCase();
            return text.indexOf(term) !== -1;
          });
        }
        
        if (filtered.length === 0) {
          resultadosContainer.innerHTML = '<div class="p-3 text-gray-500 text-sm text-center">No se encontraron pacientes con deuda pendiente</div>';
          resultadosContainer.classList.remove('hidden');
          return;
        }
        
        resultadosContainer.innerHTML = filtered.map(function(p) {
          const text = p.text || (p.nombre + ' ' + p.apellido);
          return '<div class="p-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0" data-id="' + p.id + '">' + text + '</div>';
        }).join('');
        
        // Agregar event listeners
        resultadosContainer.querySelectorAll('[data-id]').forEach(function(div) {
          div.addEventListener('click', function() {
            const pacienteId = parseInt(this.getAttribute('data-id'));
            if (pacienteHiddenInput) {
              pacienteHiddenInput.value = pacienteId;
            }
            const paciente = pacientesDataCache.find(function(p) { return p.id === pacienteId; });
            if (paciente) {
              pacienteInput.value = paciente.text || (paciente.nombre + ' ' + paciente.apellido);
            }
            resultadosContainer.classList.add('hidden');
            buscarPorPaciente(pacienteId);
          });
        });
        
        resultadosContainer.classList.remove('hidden');
      }
      
      // Event listeners
      pacienteInput.addEventListener('input', function(e) {
        const query = e.target.value;
        buscarYMostrarPacientes(query);
      });
      
      pacienteInput.addEventListener('focus', function() {
        if (pacientesDataCache.length === 0) {
          buscarYMostrarPacientes('');
        } else {
          mostrarResultadosPacientes(pacienteInput.value);
        }
      });
      
      // Ocultar resultados al hacer click fuera
      document.addEventListener('click', function(e) {
        if (!pacienteInput.contains(e.target) && !resultadosContainer.contains(e.target)) {
          resultadosContainer.classList.add('hidden');
        }
      });
      
      // Cargar pacientes iniciales
      buscarYMostrarPacientes('');
    }
    
    // Event listener para laboratorio
    const laboratorioSelect = document.getElementById('laboratorioBuscar');
    if (laboratorioSelect) {
      laboratorioSelect.addEventListener('change', function() {
        const laboratorioId = this.value;
        if (laboratorioId) {
          buscarPorLaboratorio(laboratorioId);
        } else {
          document.getElementById('resultadosLaboratorio').classList.add('hidden');
        }
      });
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializar);
  } else {
    inicializar();
  }
})();
</script>
`}) %>

