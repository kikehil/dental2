<%- include('../layout', { body: `
<div class="flex justify-end mb-6">
  <button onclick="abrirModal()" class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700">
    <i class="fas fa-plus mr-2"></i> Nuevo Servicio
  </button>
</div>

<div class="bg-white rounded-xl shadow-sm overflow-hidden">
  <table class="w-full">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-6 py-4 text-left text-sm font-medium text-gray-600">Servicio</th>
        <th class="px-6 py-4 text-left text-sm font-medium text-gray-600">Categoría</th>
        <th class="px-6 py-4 text-left text-sm font-medium text-gray-600">Duración</th>
        <th class="px-6 py-4 text-right text-sm font-medium text-gray-600">Precio</th>
        <th class="px-6 py-4 text-center text-sm font-medium text-gray-600">Estado</th>
        <th class="px-6 py-4 text-center text-sm font-medium text-gray-600">Acciones</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      ${servicios.map(s => 
        '<tr class="hover:bg-gray-50">' +
          '<td class="px-6 py-4"><p class="font-medium text-gray-800">' + s.nombre + '</p><p class="text-sm text-gray-500">' + (s.descripcion || '') + '</p></td>' +
          '<td class="px-6 py-4 text-gray-600">' + ((s.categoria && s.categoria.nombre) ? s.categoria.nombre : '-') + '</td>' +
          '<td class="px-6 py-4 text-gray-600">' + s.duracion + ' min</td>' +
          '<td class="px-6 py-4 text-right font-bold text-primary-600">' + formatCurrency(s.precio) + '</td>' +
          '<td class="px-6 py-4 text-center">' + (s.activo ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">Activo</span>' : '<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs">Inactivo</span>') + '</td>' +
          '<td class="px-6 py-4 text-center"><button onclick="editarServicio(' + JSON.stringify(s).replace(/"/g, '&quot;') + ')" class="text-primary-600 hover:text-primary-800"><i class="fas fa-edit"></i></button></td>' +
        '</tr>'
      ).join('')}
    </tbody>
  </table>
</div>

<!-- Modal -->
<div id="modalServicio" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
    <h3 class="text-lg font-bold text-gray-800 mb-4" id="modalTitulo">Nuevo Servicio</h3>
    <form id="formServicio" class="space-y-4">
      <input type="hidden" id="servicioId" name="id">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
        <input type="text" id="servicioNombre" name="nombre" required class="w-full px-3 py-2 border rounded-lg">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
        <textarea id="servicioDesc" name="descripcion" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Precio *</label>
          <input type="number" id="servicioPrecio" name="precio" required step="0.01" min="0" class="w-full px-3 py-2 border rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Duración (min)</label>
          <input type="number" id="servicioDuracion" name="duracion" value="30" min="5" class="w-full px-3 py-2 border rounded-lg">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
        <select id="servicioCategoriaId" name="categoriaId" class="w-full px-3 py-2 border rounded-lg">
          <option value="">-- Sin categoría --</option>
          ${categorias && categorias.length > 0 ? categorias.map(c => 
            '<option value="' + c.id + '">' + c.nombre + '</option>'
          ).join('') : ''}
        </select>
      </div>
      <div class="flex items-center">
        <input type="checkbox" id="servicioActivo" name="activo" checked class="mr-2">
        <label for="servicioActivo" class="text-sm text-gray-700">Activo</label>
      </div>
      <div class="flex gap-4">
        <button type="button" onclick="cerrarModal()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
        <button type="submit" class="flex-1 bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
function abrirModal() {
  document.getElementById('modalTitulo').textContent = 'Nuevo Servicio';
  document.getElementById('formServicio').reset();
  document.getElementById('servicioId').value = '';
  document.getElementById('modalServicio').classList.remove('hidden');
}

function cerrarModal() {
  document.getElementById('modalServicio').classList.add('hidden');
}

function editarServicio(s) {
  document.getElementById('modalTitulo').textContent = 'Editar Servicio';
  document.getElementById('servicioId').value = s.id;
  document.getElementById('servicioNombre').value = s.nombre;
  document.getElementById('servicioDesc').value = s.descripcion || '';
  document.getElementById('servicioPrecio').value = s.precio;
  document.getElementById('servicioDuracion').value = s.duracion;
  document.getElementById('servicioCategoriaId').value = (s.categoriaId || '');
  // categoriaTexto ya no se usa, solo categoriaId
  document.getElementById('servicioActivo').checked = s.activo;
  document.getElementById('modalServicio').classList.remove('hidden');
}

document.getElementById('formServicio').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  data.activo = document.getElementById('servicioActivo').checked ? 'true' : 'false';
  
  fetch('/configuracion/servicios', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(result => {
    if (result.success) {
      location.reload();
    } else {
      alert('Error al guardar: ' + (result.error || 'Error desconocido'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error al guardar el servicio. Por favor, verifica la consola para más detalles.');
  });
});
</script>
`}) %>

