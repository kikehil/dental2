<script>
  // Stubs para evitar errores de onclick si las funciones aún no cargan
  window.mostrarTab = function (tab) {
    if (window._mostrarTabImpl) return window._mostrarTabImpl(tab);
    // fallback simple para que los tabs funcionen aunque no se haya cargado el resto del script
    const contenedorServicios = document.getElementById('contenedorServicios');
    const contenedorCategoria = document.getElementById('contenedorCategoria');
    const contenedorProductos = document.getElementById('contenedorProductos');
    const contenedorAplazos = document.getElementById('contenedorAplazos');
    if (contenedorServicios) contenedorServicios.classList.add('hidden');
    if (contenedorCategoria) contenedorCategoria.classList.add('hidden');
    if (contenedorProductos) contenedorProductos.classList.add('hidden');
    if (contenedorAplazos) contenedorAplazos.classList.add('hidden');
    if (tab === 'servicios' && contenedorServicios) contenedorServicios.classList.remove('hidden');
    if (tab === 'categoria' && contenedorCategoria) contenedorCategoria.classList.remove('hidden');
    if (tab === 'productos' && contenedorProductos) contenedorProductos.classList.remove('hidden');
    if (tab === 'aplazos' && contenedorAplazos) contenedorAplazos.classList.remove('hidden');
    const tabServicios = document.getElementById('tabServicios');
    const tabCategoria = document.getElementById('tabCategoria');
    const tabProductos = document.getElementById('tabProductos');
    const tabAplazos = document.getElementById('tabAplazos');
    [tabServicios, tabCategoria, tabProductos, tabAplazos].forEach(t => {
      if (t) {
        t.classList.remove('border-primary-500', 'text-primary-600');
        t.classList.add('border-transparent', 'text-gray-500');
      }
    });
    if (tab === 'servicios' && tabServicios) {
      tabServicios.classList.add('border-primary-500', 'text-primary-600');
      tabServicios.classList.remove('border-transparent', 'text-gray-500');
    }
    if (tab === 'categoria' && tabCategoria) {
      tabCategoria.classList.add('border-primary-500', 'text-primary-600');
      tabCategoria.classList.remove('border-transparent', 'text-gray-500');
    }
    if (tab === 'productos' && tabProductos) {
      tabProductos.classList.add('border-primary-500', 'text-primary-600');
      tabProductos.classList.remove('border-transparent', 'text-gray-500');
    }
    if (tab === 'aplazos' && tabAplazos) {
      tabAplazos.classList.add('border-primary-500', 'text-primary-600');
      tabAplazos.classList.remove('border-transparent', 'text-gray-500');
    }
  };
  // Fallback rápido de formato de moneda para evitar ReferenceError
  if (typeof window.formatCurrency !== 'function') {
    window.formatCurrency = function (v) {
      const n = parseFloat(v || 0);
      return '$' + (isNaN(n) ? '0.00' : n.toFixed(2));
    };
  }
  window.filtrarPorCategoria = function () {
    if (window._filtrarPorCategoriaImpl) return window._filtrarPorCategoriaImpl();
    const filtroCategoria = document.getElementById('filtroCategoria');
    const categoriaId = filtroCategoria ? filtroCategoria.value : '';
    const serviciosItems = document.querySelectorAll('#listaServiciosCategoria .servicio-item');
    serviciosItems.forEach(function (item) {
      const itemCategoriaId = item.dataset.categoriaId || '';
      item.style.display = (!categoriaId || itemCategoriaId === categoriaId) ? '' : 'none';
    });
  };
  window.cargarPendientesAplazos = function () {
    if (window._cargarPendientesAplazosImpl) {
      console.log('Ejecutando cargarPendientesAplazos desde stub (implementación encontrada)');
      return window._cargarPendientesAplazosImpl();
    }
    console.warn('cargarPendientesAplazos aún no está lista - esperando implementación...');
  };
</script>
<% if (necesitaSaldoInicial) { %>
  <!-- Modal Saldo Inicial -->
  <div id="modalSaldoInicial" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    style="display: flex;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4">
      <div class="p-6 border-b">
        <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
          <i class="fas fa-cash-register text-primary-500"></i>
          Saldo Inicial de Caja
        </h3>
        <p class="text-gray-600 mt-2">Ingresa el saldo inicial para comenzar a operar</p>
      </div>
      <div class="p-6">
        <% if (tieneSaldoPredefinido) { %>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-blue-800 mb-1"><i class="fas fa-info-circle mr-1"></i>Saldo actual después de
              retiros:</p>
            <p class="text-2xl font-bold text-blue-600">$<%= saldoPredefinidoStr %>
            </p>
            <p class="text-xs text-blue-600 mt-2">Puedes aumentar este monto, pero no puedes poner menos. Si necesitas
              menos, realiza otro retiro primero.</p>
          </div>
          <% } %>
            <form id="formSaldoInicial" onsubmit="guardarSaldoInicial(event)">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Saldo Inicial ($)</label>
                <input type="number" id="saldoInicial" step="0.01" min="<%= saldoPredefinidoStr %>" required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg text-2xl font-bold text-center focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                  placeholder="0.00" value="<%= saldoPredefinidoValor %>" autofocus>
                <% if (tieneSaldoPredefinido) { %>
                  <p class="text-xs text-gray-500 mt-1">Mínimo permitido: $<%= saldoPredefinidoStr %>
                  </p>
                  <% } else { %>
                    <p class="text-xs text-gray-500 mt-1">Puede ser $0.00</p>
                    <% } %>
              </div>
              <button type="submit"
                class="w-full bg-primary-600 text-white py-3 rounded-lg hover:bg-primary-700 transition font-medium">
                <i class="fas fa-check mr-2"></i> Confirmar Saldo Inicial
              </button>
            </form>
      </div>
    </div>
  </div>
  <% } %>

    <script>
      // Preparar datos para los componentes de búsqueda (fuera del DOMContentLoaded)
      const pacientesData = <% - pacientesDataSafe %>;
      const doctoresData = <% - doctoresDataSafe %>;

      // Asegurar que el modal se muestre si necesitaSaldoInicial es true
      document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const necesitaSaldoInicial = urlParams.get('necesitaSaldoInicial') === 'true';

        if (necesitaSaldoInicial) {
          const modal = document.getElementById('modalSaldoInicial');
          if (modal) {
            modal.style.display = 'flex';
            const input = document.getElementById('saldoInicial');
            if (input) {
              input.focus();
              // El valor ya viene predefinido desde el servidor si hay saldo después de retiros
              // Si no tiene valor, usar 0.00
              if (!input.value || input.value === '0.00') {
                const saldoPredefinido = input.getAttribute('min') || '0';
                if (saldoPredefinido !== '0') {
                  input.value = saldoPredefinido;
                } else {
                  input.value = '0.00';
                }
              }
            }
          }
        }

        // Inicializar selector de banco (oculto por defecto)
        if (typeof mostrarBancos === 'function') {
          mostrarBancos();
        }

        // Inicializar componentes de búsqueda para paciente y doctor
        if (document.getElementById('pacienteVenta_search')) {
          createSearchableSelect({
            inputId: 'pacienteVenta_search',
            hiddenInputId: 'pacienteVenta',
            options: pacientesData,
            placeholder: 'Buscar paciente...',
            emptyText: 'No se encontraron pacientes'
          });
        }

        if (document.getElementById('doctorVenta_search')) {
          createSearchableSelect({
            inputId: 'doctorVenta_search',
            hiddenInputId: 'doctorVenta',
            options: doctoresData,
            placeholder: 'Buscar doctor...',
            emptyText: 'No se encontraron doctores'
          });
        }
      });
    </script>

    <div class="grid lg:grid-cols-3 gap-4 h-full min-h-0">
      <!-- Catálogo -->
      <div class="lg:col-span-2 flex flex-col h-full">
        <!-- Tabs y Selector de Moneda -->
        <div class="bg-white rounded-lg shadow-sm p-3 mb-3 flex-shrink-0">
          <div class="flex justify-between items-center">
            <div class="flex gap-4 border-b border-gray-200 flex-1">
              <button onclick="mostrarTab('servicios')" id="tabServicios"
                class="px-4 py-2 border-b-2 border-primary-500 text-primary-600 font-medium text-sm transition">
                <i class="fas fa-teeth mr-2"></i> Servicios
              </button>
              <button onclick="mostrarTab('categoria')" id="tabCategoria"
                class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm transition">
                <i class="fas fa-tags mr-2"></i> Por Categoría
              </button>
              <button onclick="mostrarTab('productos')" id="tabProductos"
                class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm transition">
                <i class="fas fa-box mr-2"></i> Productos
              </button>
              <button onclick="mostrarTab('aplazos')" id="tabAplazos"
                class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm transition">
                <i class="fas fa-calendar-check mr-2"></i> A Plazos
              </button>
            </div>
            <div class="ml-4 flex items-center gap-2">
              <label class="text-xs font-medium text-gray-700">Moneda:</label>
              <select id="selectorMoneda" onchange="cambiarMoneda()"
                class="px-3 py-1.5 border border-gray-300 bg-white rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                <option value="MXN">MXN</option>
                <option value="USD">USD</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Contenedor con scroll para Servicios -->
        <div id="contenedorServicios" class="flex-1 min-h-0 bg-white rounded-lg shadow-sm p-1.5">
          <div id="listaServicios" class="overflow-y-auto" style="max-height: calc(100vh - 300px); height: 100%;">
            <div class="grid grid-cols-3 gap-1.5 auto-rows-max">
              <% servicios.forEach(function(s) { const categoriaNombre=(s.categoria && s.categoria.nombre) ?
                s.categoria.nombre : 'General' ; %>
                <div
                  class="bg-white rounded border border-gray-200 p-2 hover:bg-blue-50 hover:border-blue-300 hover:shadow transition-all duration-200 cursor-pointer w-full"
                  data-tipo="servicio" data-id="<%= s.id %>" data-nombre="<%= s.nombre %>" data-precio="<%= s.precio %>"
                  data-categoria-id="<%= s.categoriaId || '' %>"
                  title="<%= s.nombre %> - <%= formatCurrency(s.precio) %>">
                  <div class="flex flex-col">
                    <h4 class="text-xs font-semibold text-gray-800 mb-0.5 line-clamp-2 leading-tight">
                      <%= s.nombre %>
                    </h4>
                    <p class="text-xs text-gray-500 mb-1 leading-tight">
                      <%= categoriaNombre %> • <%= s.duracion %> min
                    </p>
                    <p class="text-xs font-bold text-blue-600">
                      <%= formatCurrency(s.precio) %>
                    </p>
                  </div>
                </div>
                <% }); %>
            </div>
          </div>
        </div>

        <!-- Contenedor con scroll para Por Categoría -->
        <div id="contenedorCategoria" class="flex-1 min-h-0 bg-white rounded-lg shadow-sm p-1.5 hidden">
          <div class="mb-3 flex-shrink-0">
            <label class="block text-xs font-medium text-gray-700 mb-1.5">Filtrar por Categoría</label>
            <select id="filtroCategoria" onchange="filtrarPorCategoria()"
              class="w-full px-3 py-2 border border-gray-300 bg-white rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
              <option value="">-- Todas las categorías --</option>
              <% if (categorias && categorias.length> 0) { %>
                <% categorias.forEach(function(c) { %>
                  <option value="<%= c.id %>">
                    <%= c.nombre %>
                  </option>
                  <% }); %>
                    <% } %>
            </select>
          </div>
          <div id="listaServiciosCategoria" class="overflow-y-auto"
            style="max-height: calc(100vh - 350px); height: 100%;">
            <div class="grid grid-cols-3 gap-1.5 auto-rows-max">
              <% servicios.forEach(function(s) { const categoriaNombre=(s.categoria && s.categoria.nombre) ?
                s.categoria.nombre : 'General' ; %>
                <div
                  class="bg-white rounded border border-gray-200 p-2 hover:bg-blue-50 hover:border-blue-300 hover:shadow transition-all duration-200 cursor-pointer w-full servicio-item"
                  data-tipo="servicio" data-id="<%= s.id %>" data-nombre="<%= s.nombre %>" data-precio="<%= s.precio %>"
                  data-categoria-id="<%= s.categoriaId || '' %>"
                  title="<%= s.nombre %> - <%= formatCurrency(s.precio) %>">
                  <div class="flex flex-col">
                    <h4 class="text-xs font-semibold text-gray-800 mb-0.5 line-clamp-2 leading-tight">
                      <%= s.nombre %>
                    </h4>
                    <p class="text-xs text-gray-500 mb-1 leading-tight">
                      <%= categoriaNombre %> • <%= s.duracion %> min
                    </p>
                    <p class="text-xs font-bold text-blue-600">
                      <%= formatCurrency(s.precio) %>
                    </p>
                  </div>
                </div>
                <% }); %>
            </div>
          </div>
        </div>

        <!-- Contenedor con scroll para Productos -->
        <div id="contenedorProductos" class="flex-1 min-h-0 bg-white rounded-lg shadow-sm p-1.5 hidden">
          <div id="listaProductos" class="overflow-y-auto" style="max-height: calc(100vh - 300px); height: 100%;">
            <div class="grid grid-cols-3 gap-1.5 auto-rows-max">
              <% productos.forEach(function(p) { %>
                <div
                  class="bg-white rounded border border-gray-200 p-2 hover:bg-blue-50 hover:border-blue-300 hover:shadow transition-all duration-200 cursor-pointer w-full <%= p.stock <= 0 ? 'opacity-50' : '' %>"
                  data-tipo="producto" data-id="<%= p.id %>" data-nombre="<%= p.nombre %>" data-precio="<%= p.precio %>"
                  data-stock="<%= p.stock %>"
                  title="<%= p.nombre %> - Stock: <%= p.stock %> - <%= formatCurrency(p.precio) %>">
                  <div class="flex flex-col">
                    <h4 class="text-xs font-semibold text-gray-800 mb-0.5 line-clamp-2 leading-tight">
                      <%= p.nombre %>
                    </h4>
                    <p class="text-xs text-gray-500 mb-1 leading-tight">Stock: <span
                        class="font-medium <%= p.stock <= p.stockMinimo ? 'text-red-600' : 'text-green-600' %>">
                        <%= p.stock %>
                      </span></p>
                    <p class="text-xs font-bold text-blue-600">
                      <%= formatCurrency(p.precio) %>
                    </p>
                  </div>
                </div>
                <% }); %>
            </div>
          </div>
        </div>

        <!-- Contenedor para Aplazos -->
        <div id="contenedorAplazos" class="flex-1 min-h-0 bg-white rounded-lg shadow-sm p-4 hidden">
          <div class="mb-4 relative">
            <label class="block text-sm font-medium text-gray-700 mb-2">Buscar Paciente</label>
            <input type="text" id="buscarPacienteAplazos" placeholder="Escribe el nombre del paciente..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">

            <!-- Lista de resultados de búsqueda -->
            <div id="listaResultadosPacientes"
              class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
              <!-- Los resultados se insertarán aquí dinámicamente -->
            </div>
          </div>

          <!-- Lista de pacientes con tratamientos pendientes -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-gray-800">Pacientes con tratamientos pendientes</h3>
              <button type="button" id="btnActualizarPendientes"
                class="text-xs text-primary-600 hover:underline">Actualizar</button>
            </div>
            <div id="gridPacientesPendientes"
              class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-64 overflow-y-auto p-1">
              <p class="text-gray-400 text-xs italic col-span-full">Cargando pacientes con deuda...</p>
            </div>
            <div id="listaPendientesAplazos" class="space-y-3 text-sm text-gray-700 mt-3 hidden">
            </div>
          </div>

          <div id="tratamientosPaciente" class="space-y-4 hidden">
            <h3 class="text-lg font-bold text-gray-800 mb-3">Tratamientos Pendientes</h3>
            <div id="listaTratamientos"></div>
          </div>

          <div id="sinTratamientos" class="text-center py-8 text-gray-500 hidden">
            <i class="fas fa-info-circle text-4xl mb-2"></i>
            <p>No se encontraron tratamientos pendientes para este paciente</p>
          </div>
        </div>
      </div>

      <!-- Carrito -->
      <div class="lg:col-span-1 flex flex-col h-full">
        <div class="bg-white rounded-lg shadow-lg border border-gray-200 p-4 flex flex-col h-full">
          <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center flex-shrink-0">
            <i class="fas fa-shopping-cart text-blue-600 mr-2"></i>
            Carrito
          </h3>

          <div class="mb-3 flex-shrink-0">
            <label class="block text-xs font-medium text-gray-700 mb-1.5">Doctor (opcional)</label>
            <input type="hidden" id="doctorVenta">
            <input type="text" id="doctorVenta_search"
              class="w-full px-3 py-2 border border-gray-300 bg-white rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Buscar doctor..." autocomplete="off">
          </div>

          <div class="mb-3 flex-shrink-0">
            <label class="block text-xs font-medium text-gray-700 mb-1.5">Paciente (opcional)</label>
            <input type="hidden" id="pacienteVenta">
            <input type="text" id="pacienteVenta_search"
              class="w-full px-3 py-2 border border-gray-300 bg-white rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Buscar paciente..." autocomplete="off">
          </div>

          <div id="itemsCarrito" class="overflow-y-auto bg-gray-50 rounded-lg p-3 border border-gray-200 mb-3"
            style="max-height: calc(100vh - 500px); height: 100%;">
            <p class="text-gray-500 text-center py-8 text-sm">Carrito vacío</p>
          </div>

          <div class="border-t border-gray-200 pt-3 space-y-2 mb-3 flex-shrink-0">
            <div class="flex justify-between items-center text-xs">
              <span class="text-gray-500">Moneda:</span>
              <span id="monedaCarrito" class="font-medium text-gray-700">MXN</span>
            </div>
            <div class="flex justify-between text-sm text-gray-700">
              <span>Subtotal:</span>
              <span id="subtotal" class="font-medium">$0.00 MXN</span>
            </div>
            <div class="flex justify-between items-center text-sm text-gray-700">
              <span>Descuento:</span>
              <input type="number" id="descuento" value="0" min="0" step="0.01"
                class="w-24 px-2 py-1 border border-gray-300 rounded text-right text-sm" onchange="actualizarTotales()">
            </div>
            <div class="flex justify-between text-lg font-bold text-gray-800 pt-1 border-t border-gray-200">
              <span>Total:</span>
              <span id="total">$0.00 MXN</span>
            </div>
          </div>

          <div class="mb-3 flex-shrink-0">
            <label class="block text-xs font-medium text-gray-700 mb-1.5">Método de pago</label>
            <select id="metodoPago" onchange="mostrarBancos()"
              class="w-full px-3 py-2 border border-gray-300 bg-white rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="efectivo">Efectivo</option>
              <option value="tarjeta">Tarjeta</option>
              <option value="transferencia">Transferencia</option>
            </select>
          </div>

          <div id="selectorBanco" class="mb-3 hidden flex-shrink-0">
            <label class="block text-xs font-medium text-gray-700 mb-1">Banco <span
                class="text-red-500">*</span></label>
            <div id="errorBanco" class="text-red-500 text-xs mb-1 hidden">Debes seleccionar un banco</div>
            <div class="flex gap-2 justify-between">
              <div class="flex-1 cursor-pointer banco-option" data-banco="BBVA" onclick="seleccionarBanco('BBVA')">
                <div
                  class="bg-white border-2 border-primary-200 rounded-lg p-2 hover:border-primary-500 transition text-center banco-item h-full flex flex-col items-center justify-center min-h-[80px]">
                  <div class="w-full h-12 mb-1 flex items-center justify-center relative">
                    <img src="/bancos/bbva.png" alt="BBVA" class="max-w-full max-h-full object-contain"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                      onload="this.nextElementSibling.style.display='none';">
                    <div
                      class="bg-blue-600 text-white px-3 py-2 rounded text-xs font-bold h-12 w-full flex items-center justify-center"
                      style="display:none;">BBVA</div>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Bancomer</p>
                </div>
              </div>
              <div class="flex-1 cursor-pointer banco-option" data-banco="Mercado Pago"
                onclick="seleccionarBanco('Mercado Pago')">
                <div
                  class="bg-white border-2 border-primary-200 rounded-lg p-2 hover:border-primary-500 transition text-center banco-item h-full flex flex-col items-center justify-center min-h-[80px]">
                  <div class="w-full h-12 mb-1 flex items-center justify-center relative">
                    <img src="/bancos/mercadopago.png" alt="Mercado Pago" class="max-w-full max-h-full object-contain"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                      onload="this.nextElementSibling.style.display='none';">
                    <div
                      class="bg-blue-400 text-white px-3 py-2 rounded text-xs font-bold h-12 w-full flex items-center justify-center"
                      style="display:none;">Mercado Pago</div>
                  </div>
                </div>
              </div>
              <div class="flex-1 cursor-pointer banco-option" data-banco="Azteca" onclick="seleccionarBanco('Azteca')">
                <div
                  class="bg-white border-2 border-primary-200 rounded-lg p-2 hover:border-primary-500 transition text-center banco-item h-full flex flex-col items-center justify-center min-h-[80px]">
                  <div class="w-full h-12 mb-1 flex items-center justify-center relative">
                    <img src="/bancos/azteca.png" alt="Banco Azteca" class="max-w-full max-h-full object-contain"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                      onload="this.nextElementSibling.style.display='none';">
                    <div
                      class="bg-green-500 text-white px-3 py-2 rounded text-xs font-bold h-12 w-full flex items-center justify-center"
                      style="display:none;">Azteca</div>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Banco Azteca</p>
                </div>
              </div>
            </div>
            <input type="hidden" id="bancoSeleccionado" value="">
          </div>

          <button onclick="procesarVenta()"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition font-medium text-sm shadow-md hover:shadow-lg flex-shrink-0">
            <i class="fas fa-cash-register mr-2"></i> Cobrar
          </button>
        </div>
      </div>
    </div>

    <script>
      let carrito = [];
      let monedaActual = localStorage.getItem('monedaPOS') || 'MXN';
      const tipoCambio = <% - tipoCambio || 20.0 %>;

      // Funciones de conversión de moneda
      function convertirPrecio(precioMXN) {
        if (monedaActual === 'USD') {
          return parseFloat(precioMXN) / tipoCambio;
        }
        return parseFloat(precioMXN);
      }

      function formatearPrecio(precio) {
        const precioConvertido = convertirPrecio(precio);
        if (monedaActual === 'USD') {
          return '$' + precioConvertido.toFixed(2) + ' USD';
        }
        return '$' + precioConvertido.toFixed(2) + ' MXN';
      }

      function cambiarMoneda() {
        const selector = document.getElementById('selectorMoneda');
        monedaActual = selector.value;
        localStorage.setItem('monedaPOS', monedaActual);
        actualizarPrecios();
        renderCarrito();
        // Actualizar moneda en el carrito
        const monedaCarrito = document.getElementById('monedaCarrito');
        if (monedaCarrito) {
          monedaCarrito.textContent = monedaActual;
        }
      }

      function actualizarPrecios() {
        // Actualizar precios de servicios
        document.querySelectorAll('#listaServicios [data-precio]').forEach(function (item) {
          const precioOriginal = parseFloat(item.dataset.precio);
          const precioElement = item.querySelector('p.text-primary-600, p.text-secondary-600');
          if (precioElement) {
            precioElement.textContent = formatearPrecio(precioOriginal);
          }
        });

        // Actualizar precios de productos
        document.querySelectorAll('#listaProductos [data-precio]').forEach(function (item) {
          const precioOriginal = parseFloat(item.dataset.precio);
          const precioElement = item.querySelector('p.text-secondary-600');
          if (precioElement) {
            precioElement.textContent = formatearPrecio(precioOriginal);
          }
        });
      }

      // Inicializar moneda al cargar
      document.addEventListener('DOMContentLoaded', function () {
        const selectorMoneda = document.getElementById('selectorMoneda');
        if (selectorMoneda) {
          selectorMoneda.value = monedaActual;
          actualizarPrecios();
        }
        // Actualizar moneda en el carrito
        const monedaCarrito = document.getElementById('monedaCarrito');
        if (monedaCarrito) {
          monedaCarrito.textContent = monedaActual;
        }
      });

      // Event delegation para agregar items
      document.getElementById('listaServicios').addEventListener('click', function (e) {
        const item = e.target.closest('[data-tipo]');
        if (item) {
          agregarItem(item.dataset.tipo, parseInt(item.dataset.id), item.dataset.nombre, parseFloat(item.dataset.precio));
        }
      });

      // Event delegation para servicios por categoría
      const listaServiciosCategoria = document.getElementById('listaServiciosCategoria');
      if (listaServiciosCategoria) {
        listaServiciosCategoria.addEventListener('click', function (e) {
          const item = e.target.closest('[data-tipo]');
          if (item && item.style.display !== 'none') {
            agregarItem(item.dataset.tipo, parseInt(item.dataset.id), item.dataset.nombre, parseFloat(item.dataset.precio));
          }
        });
      }

      document.getElementById('listaProductos').addEventListener('click', function (e) {
        const item = e.target.closest('[data-tipo]');
        if (item && parseInt(item.dataset.stock) > 0) {
          agregarItem(item.dataset.tipo, parseInt(item.dataset.id), item.dataset.nombre, parseFloat(item.dataset.precio));
        }
      });

      function mostrarTab(tab) {
        // Obtener los contenedores
        const contenedorServicios = document.getElementById('contenedorServicios');
        const contenedorCategoria = document.getElementById('contenedorCategoria');
        const contenedorProductos = document.getElementById('contenedorProductos');
        const contenedorAplazos = document.getElementById('contenedorAplazos');

        // Ocultar todos los contenedores
        if (contenedorServicios) contenedorServicios.classList.add('hidden');
        if (contenedorCategoria) contenedorCategoria.classList.add('hidden');
        if (contenedorProductos) contenedorProductos.classList.add('hidden');
        if (contenedorAplazos) contenedorAplazos.classList.add('hidden');

        // Mostrar el contenedor correspondiente
        if (tab === 'servicios') {
          if (contenedorServicios) contenedorServicios.classList.remove('hidden');
        } else if (tab === 'categoria') {
          if (contenedorCategoria) contenedorCategoria.classList.remove('hidden');
          // Filtrar por categoría al mostrar la pestaña
          filtrarPorCategoria();
        } else if (tab === 'productos') {
          if (contenedorProductos) contenedorProductos.classList.remove('hidden');
        } else if (tab === 'aplazos') {
          if (contenedorAplazos) contenedorAplazos.classList.remove('hidden');
          // Limpiar búsqueda al mostrar la pestaña
          const buscarInput = document.getElementById('buscarPacienteAplazos');
          if (buscarInput) buscarInput.value = '';
          const listaResultados = document.getElementById('listaResultadosPacientes');
          if (listaResultados) listaResultados.classList.add('hidden');
          const tratamientos = document.getElementById('tratamientosPaciente');
          if (tratamientos) tratamientos.classList.add('hidden');
          const sinTratamientos = document.getElementById('sinTratamientos');
          if (sinTratamientos) sinTratamientos.classList.add('hidden');
          // Cargar pendientes (con retraso para asegurar que la función esté definida)
          setTimeout(function () {
            console.log('Intentando cargar pendientes desde mostrarTab...');
            if (typeof cargarPendientesAplazos === 'function') {
              console.log('cargarPendientesAplazos encontrada como función local');
              cargarPendientesAplazos();
            } else if (window.cargarPendientesAplazos && typeof window.cargarPendientesAplazos === 'function') {
              console.log('cargarPendientesAplazos encontrada en window');
              window.cargarPendientesAplazos();
            } else {
              console.error('cargarPendientesAplazos no está disponible');
            }
          }, 300);
        }

        // Actualizar estilos de tabs
        const tabServicios = document.getElementById('tabServicios');
        const tabCategoria = document.getElementById('tabCategoria');
        const tabProductos = document.getElementById('tabProductos');
        const tabAplazos = document.getElementById('tabAplazos');

        // Resetear todos los tabs
        [tabServicios, tabCategoria, tabProductos, tabAplazos].forEach(t => {
          if (t) {
            t.classList.remove('border-primary-500', 'text-primary-600');
            t.classList.add('border-transparent', 'text-gray-500');
          }
        });

        // Activar el tab correspondiente
        if (tab === 'servicios' && tabServicios) {
          tabServicios.classList.add('border-primary-500', 'text-primary-600');
          tabServicios.classList.remove('border-transparent', 'text-gray-500');
        } else if (tab === 'categoria' && tabCategoria) {
          tabCategoria.classList.add('border-primary-500', 'text-primary-600');
          tabCategoria.classList.remove('border-transparent', 'text-gray-500');
        } else if (tab === 'productos' && tabProductos) {
          tabProductos.classList.add('border-primary-500', 'text-primary-600');
          tabProductos.classList.remove('border-transparent', 'text-gray-500');
        } else if (tab === 'aplazos' && tabAplazos) {
          tabAplazos.classList.add('border-primary-500', 'text-primary-600');
          tabAplazos.classList.remove('border-transparent', 'text-gray-500');
        }
      }
      // Exponer para handlers inline
      window._mostrarTabImpl = mostrarTab;
      window._filtrarPorCategoriaImpl = filtrarPorCategoria;
      window.mostrarTab = mostrarTab;
      window.filtrarPorCategoria = filtrarPorCategoria;
      // Exponer funciones para manejadores inline
      window.mostrarTab = mostrarTab;
      window.filtrarPorCategoria = filtrarPorCategoria;

      function filtrarPorCategoria() {
        const filtroCategoria = document.getElementById('filtroCategoria');
        const categoriaId = filtroCategoria ? filtroCategoria.value : '';
        const serviciosItems = document.querySelectorAll('#listaServiciosCategoria .servicio-item');

        serviciosItems.forEach(function (item) {
          const itemCategoriaId = item.dataset.categoriaId || '';
          if (!categoriaId || itemCategoriaId === categoriaId) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
      }

      function agregarItem(tipo, id, nombre, precio) {
        const existe = carrito.find(i => i.tipo === tipo && i.id === id);
        if (existe) {
          existe.cantidad++;
        } else {
          // Guardar el precio original para referencia
          carrito.push({ tipo, id, nombre, precio, cantidad: 1, precioOriginal: precio });
        }
        renderCarrito();
      }

      function quitarItem(index) {
        carrito.splice(index, 1);
        renderCarrito();
      }

      function cambiarCantidad(index, delta) {
        carrito[index].cantidad += delta;
        if (carrito[index].cantidad <= 0) {
          carrito.splice(index, 1);
        }
        renderCarrito();
      }

      function renderCarrito() {
        const container = document.getElementById('itemsCarrito');
        if (carrito.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center py-8 text-sm">Carrito vacío</p>';
        } else {
          container.innerHTML = carrito.map(function (item, i) {
            // Si es un abono, mostrar de manera diferente
            if (item.tipo === 'abono') {
              const precioOriginal = monedaActual === 'USD' ? item.precio * tipoCambio : item.precio;
              return '<div class="flex items-center justify-between p-2.5 bg-green-50 rounded-lg border border-green-200 mb-2 shadow-sm">' +
                '<div class="flex-1 min-w-0 mr-3">' +
                '<p class="text-sm font-medium text-gray-800 truncate mb-1 flex items-center gap-2">' +
                '<i class="fas fa-calendar-check text-green-600"></i>' +
                item.nombre +
                '</p>' +
                '<div class="flex items-center gap-2 flex-wrap">' +
                '<span class="text-xs text-gray-600 whitespace-nowrap">Monto:</span>' +
                '<span class="text-xs font-bold text-green-700 whitespace-nowrap">' + formatCurrency(precioOriginal) + ' ' + monedaActual + '</span>' +
                '</div>' +
                '</div>' +
                '<div class="flex items-center gap-1.5 flex-shrink-0 ml-2">' +
                '<button onclick="quitarItem(' + i + ')" class="text-red-500 hover:text-red-700 p-1.5 hover:bg-red-50 rounded transition"><i class="fas fa-trash text-xs"></i></button>' +
                '</div>' +
                '</div>';
            }

            // Obtener el precio original en MXN para el input
            const precioOriginal = monedaActual === 'USD' ? item.precio * tipoCambio : item.precio;
            return '<div class="flex items-center justify-between p-2.5 bg-white rounded-lg border border-gray-200 mb-2 shadow-sm hover:shadow transition">' +
              '<div class="flex-1 min-w-0 mr-3">' +
              '<p class="text-sm font-medium text-gray-800 truncate mb-1">' + item.nombre + '</p>' +
              '<div class="flex items-center gap-2 flex-wrap">' +
              '<span class="text-xs text-gray-500 whitespace-nowrap">Precio:</span>' +
              '<input type="number" step="0.01" min="0" value="' + precioOriginal.toFixed(2) + '" ' +
              'onchange="actualizarPrecio(' + i + ', this.value)" ' +
              'onblur="actualizarPrecio(' + i + ', this.value)" ' +
              'class="w-20 px-2 py-1 border border-yellow-300 bg-yellow-50 rounded text-xs font-semibold text-gray-800 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400" ' +
              'style="text-align: center;">' +
              '<span class="text-xs text-gray-500 whitespace-nowrap">' + monedaActual + '</span>' +
              '<span class="text-xs text-gray-500 whitespace-nowrap">x ' + item.cantidad + '</span>' +
              '</div>' +
              '</div>' +
              '<div class="flex items-center gap-1.5 flex-shrink-0 ml-2">' +
              '<button onclick="cambiarCantidad(' + i + ', -1)" class="w-7 h-7 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-sm transition flex items-center justify-center">-</button>' +
              '<span class="w-7 text-center font-medium text-gray-700 text-sm">' + item.cantidad + '</span>' +
              '<button onclick="cambiarCantidad(' + i + ', 1)" class="w-7 h-7 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-sm transition flex items-center justify-center">+</button>' +
              '<button onclick="quitarItem(' + i + ')" class="text-red-500 hover:text-red-700 p-1.5 hover:bg-red-50 rounded transition"><i class="fas fa-trash text-xs"></i></button>' +
              '</div>' +
              '</div>';
          }).join('');
        }
        actualizarTotales();
      }

      function actualizarPrecio(index, nuevoPrecio) {
        if (index < 0 || index >= carrito.length) return;

        const precioNum = parseFloat(nuevoPrecio);
        if (isNaN(precioNum) || precioNum < 0) {
          // Si el precio no es válido, restaurar el precio original
          renderCarrito();
          return;
        }

        // Convertir el precio a la moneda base (MXN) si está en USD
        if (monedaActual === 'USD') {
          carrito[index].precio = precioNum / tipoCambio;
        } else {
          carrito[index].precio = precioNum;
        }

        // Guardar el precio original para referencia
        if (!carrito[index].precioOriginal) {
          carrito[index].precioOriginal = carrito[index].precio;
        }

        actualizarTotales();
      }

      function actualizarTotales() {
        // Filtrar items informativos (abonos ya tienen precio, solo excluir paciente_info si existe)
        const itemsConPrecio = carrito.filter(function (item) {
          return item.tipo !== 'paciente_info';
        });
        const subtotal = itemsConPrecio.reduce(function (sum, item) { return sum + (item.precio * item.cantidad); }, 0);
        const descuento = parseFloat(document.getElementById('descuento').value) || 0;
        const total = subtotal - descuento;
        document.getElementById('subtotal').textContent = formatearPrecio(subtotal);
        document.getElementById('total').textContent = formatearPrecio(total);
      }

      let bancoSeleccionado = '';

      function mostrarBancos() {
        const metodoPago = document.getElementById('metodoPago').value;
        const selectorBanco = document.getElementById('selectorBanco');
        const errorBanco = document.getElementById('errorBanco');

        if (metodoPago === 'tarjeta' || metodoPago === 'transferencia') {
          selectorBanco.classList.remove('hidden');
          // Resetear selección cuando se cambia el método de pago
          bancoSeleccionado = '';
          document.getElementById('bancoSeleccionado').value = '';
          // Resetear estilos visuales
          document.querySelectorAll('.banco-option').forEach(function (item) {
            const bancoItem = item.querySelector('.banco-item');
            bancoItem.classList.remove('border-primary-500', 'bg-primary-50', 'border-red-500');
            bancoItem.classList.add('border-primary-200');
          });
          // Ocultar error inicialmente
          if (errorBanco) {
            errorBanco.classList.add('hidden');
          }
        } else {
          selectorBanco.classList.add('hidden');
          bancoSeleccionado = '';
          document.getElementById('bancoSeleccionado').value = '';
          if (errorBanco) {
            errorBanco.classList.add('hidden');
          }
        }
      }

      function seleccionarBanco(banco) {
        bancoSeleccionado = banco;
        document.getElementById('bancoSeleccionado').value = banco;

        // Ocultar mensaje de error
        const errorBanco = document.getElementById('errorBanco');
        if (errorBanco) {
          errorBanco.classList.add('hidden');
        }

        // Actualizar estilos visuales
        document.querySelectorAll('.banco-option').forEach(function (item) {
          const bancoItem = item.querySelector('.banco-item');
          if (item.dataset.banco === banco) {
            bancoItem.classList.add('border-primary-500', 'bg-primary-50');
            bancoItem.classList.remove('border-primary-200', 'border-red-500');
          } else {
            bancoItem.classList.remove('border-primary-500', 'bg-primary-50', 'border-red-500');
            bancoItem.classList.add('border-primary-200');
          }
        });
      }

      function procesarVenta() {
        // Filtrar items informativos antes de validar
        const itemsConPrecio = carrito.filter(function (item) {
          return item.tipo !== 'paciente_info';
        });

        if (itemsConPrecio.length === 0) {
          mostrarNotificacion('warning', 'Carrito Vacío', 'Agrega productos o servicios antes de cobrar');
          return;
        }

        const metodoPago = document.getElementById('metodoPago').value;
        const selectorBanco = document.getElementById('selectorBanco');
        const errorBanco = document.getElementById('errorBanco');

        // Validar que se seleccione un banco si es tarjeta o transferencia
        if (metodoPago === 'tarjeta' || metodoPago === 'transferencia') {
          if (!bancoSeleccionado || bancoSeleccionado === '') {
            // Mostrar error visual
            if (errorBanco) {
              errorBanco.classList.remove('hidden');
            }
            // Resaltar visualmente los bancos
            document.querySelectorAll('.banco-option').forEach(function (item) {
              const bancoItem = item.querySelector('.banco-item');
              bancoItem.classList.add('border-red-500');
              bancoItem.classList.remove('border-primary-200');
            });
            // Mostrar notificación
            mostrarNotificacion('warning', 'Banco Requerido', 'Por favor selecciona un banco para continuar');
            // Hacer scroll al selector de banco
            selectorBanco.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            return;
          }
        }

        // Procesar la venta directamente (sin validar límite antes)
        procesarVentaReal();
      }

      function procesarVentaReal() {
        // Filtrar items informativos antes de validar
        const itemsConPrecio = carrito.filter(function (item) {
          return item.tipo !== 'paciente_info';
        });

        const metodoPago = document.getElementById('metodoPago').value;

        var data = {
          pacienteId: document.getElementById('pacienteVenta').value || null,
          doctorId: document.getElementById('doctorVenta').value || null,
          items: itemsConPrecio, // Solo enviar items con precio
          descuento: parseFloat(document.getElementById('descuento').value) || 0,
          metodoPago: metodoPago,
          banco: bancoSeleccionado || null,
          moneda: monedaActual || 'MXN'
        };

        fetch('/pos/venta', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
          .then(function (response) { return response.json(); })
          .then(function (result) {
            if (result.success) {
              // Limpiar carrito y formulario
              carrito = [];
              renderCarrito();
              document.getElementById('descuento').value = 0;
              document.getElementById('doctorVenta').value = '';
              document.getElementById('pacienteVenta').value = '';
              document.getElementById('metodoPago').value = 'efectivo';
              bancoSeleccionado = '';
              document.getElementById('bancoSeleccionado').value = '';
              // Resetear estilos de bancos
              document.querySelectorAll('.banco-option').forEach(function (item) {
                const bancoItem = item.querySelector('.banco-item');
                bancoItem.classList.remove('border-primary-500', 'bg-primary-50', 'border-red-500');
                bancoItem.classList.add('border-primary-200');
              });
              // Ocultar error de banco
              const errorBanco = document.getElementById('errorBanco');
              if (errorBanco) {
                errorBanco.classList.add('hidden');
              }
              mostrarBancos();

              // Actualizar saldos inmediatamente después de la venta
              if (typeof actualizarSaldos === 'function') {
                actualizarSaldos();
              }

              // Si el método de pago fue efectivo, validar límite DESPUÉS de procesar la venta
              const metodoPago = document.getElementById('metodoPago').value;
              const totalVenta = result.venta.totalNumero || parseFloat(result.venta.total.replace(/[^0-9.-]/g, '')) || 0;

              if (metodoPago === 'efectivo') {
                // Esperar un momento para que se actualice el saldo en el servidor
                setTimeout(function () {
                  verificarLimiteEfectivoDespuesVenta(totalVenta, result.venta);
                }, 500);
              } else {
                // Si no es efectivo, mostrar notificación de éxito
                mostrarNotificacion('success', '¡Venta Completada!',
                  '<div class="text-center">' +
                  '<p class="text-2xl font-bold text-green-600 mb-2">' + result.venta.total + '</p>' +
                  '<p class="text-gray-500">Folio: <span class="font-mono font-bold">' + result.venta.folio + '</span></p>' +
                  '</div>'
                );
              }
            } else {
              mostrarNotificacion('error', 'Error', result.error);
            }
          })
          .catch(function (error) { mostrarNotificacion('error', 'Error', 'No se pudo procesar la venta'); });
      }

      // Verificar límite de efectivo DESPUÉS de procesar venta
      function verificarLimiteEfectivoDespuesVenta(montoVentaNumero, ventaData) {
        fetch('/pos/limite-efectivo')
          .then(function (response) { return response.json(); })
          .then(function (result) {
            if (result.success) {
              const saldoActual = parseFloat(result.saldoActual) || 0;
              const limiteMaximo = parseFloat(result.limiteMaximo) || 0;

              // Si hay límite configurado (mayor a 0) y el saldo actual alcanza o supera el límite
              if (limiteMaximo > 0 && saldoActual >= limiteMaximo) {
                mostrarModalRetiro(saldoActual, limiteMaximo, saldoActual, function () {
                  // Después de realizar el retiro, mostrar notificación de venta completada
                  mostrarNotificacion('success', '¡Venta Completada!',
                    '<div class="text-center">' +
                    '<p class="text-2xl font-bold text-green-600 mb-2">' + (ventaData.total || '$' + montoVentaNumero.toFixed(2)) + '</p>' +
                    '<p class="text-gray-500">Folio: <span class="font-mono font-bold">' + (ventaData.folio || '') + '</span></p>' +
                    '</div>'
                  );
                });
              } else {
                // No hay límite o no se alcanza, mostrar notificación de éxito
                mostrarNotificacion('success', '¡Venta Completada!',
                  '<div class="text-center">' +
                  '<p class="text-2xl font-bold text-green-600 mb-2">' + (ventaData.total || '$' + montoVentaNumero.toFixed(2)) + '</p>' +
                  '<p class="text-gray-500">Folio: <span class="font-mono font-bold">' + (ventaData.folio || '') + '</span></p>' +
                  '</div>'
                );
              }
            } else {
              // Si hay error al obtener el límite, mostrar notificación de éxito de todas formas
              console.error('Error al verificar límite:', result.error);
              mostrarNotificacion('success', '¡Venta Completada!',
                '<div class="text-center">' +
                '<p class="text-2xl font-bold text-green-600 mb-2">' + (ventaData.total || '$' + montoVentaNumero.toFixed(2)) + '</p>' +
                '<p class="text-gray-500">Folio: <span class="font-mono font-bold">' + (ventaData.folio || '') + '</span></p>' +
                '</div>'
              );
            }
          })
          .catch(function (error) {
            console.error('Error al verificar límite:', error);
            // Si hay error, mostrar notificación de éxito de todas formas
            mostrarNotificacion('success', '¡Venta Completada!',
              '<div class="text-center">' +
              '<p class="text-2xl font-bold text-green-600 mb-2">' + (ventaData.total || '$' + montoVentaNumero.toFixed(2)) + '</p>' +
              '<p class="text-gray-500">Folio: <span class="font-mono font-bold">' + (ventaData.folio || '') + '</span></p>' +
              '</div>'
            );
          });
      }

      // Mostrar modal para solicitar retiros
      function mostrarModalRetiro(saldoActual, limiteMaximo, saldoDespuesVenta, callback) {
        const montoExcedente = Math.max(0, saldoDespuesVenta - limiteMaximo);

        const modal = document.createElement('div');
        modal.id = 'modalRetiroLimite';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML =
          '<div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden" style="animation: slideUp 0.3s ease-out">' +
          '<div class="p-6 border-b bg-amber-50">' +
          '<div class="flex items-center gap-3 mb-2">' +
          '<div class="w-12 h-12 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center text-xl">' +
          '<i class="fas fa-exclamation-triangle"></i>' +
          '</div>' +
          '<div>' +
          '<h3 class="text-xl font-bold text-gray-800">Límite de Efectivo Alcanzado</h3>' +
          '<p class="text-sm text-gray-600">Favor de realizar el retiro</p>' +
          '</div>' +
          '</div>' +
          '</div>' +
          '<div class="p-6">' +
          '<div class="bg-gray-50 rounded-lg p-4 mb-4">' +
          '<div class="grid grid-cols-2 gap-4 text-sm">' +
          '<div>' +
          '<p class="text-gray-500 mb-1">Saldo Actual:</p>' +
          '<p class="text-lg font-bold text-gray-800">$' + parseFloat(saldoActual).toFixed(2) + '</p>' +
          '</div>' +
          '<div>' +
          '<p class="text-gray-500 mb-1">Límite Máximo:</p>' +
          '<p class="text-lg font-bold text-amber-600">$' + parseFloat(limiteMaximo).toFixed(2) + '</p>' +
          '</div>' +
          '<div class="col-span-2">' +
          '<p class="text-gray-500 mb-1">Monto a retirar (mínimo):</p>' +
          '<p class="text-lg font-bold text-primary-600">$' + parseFloat(montoExcedente).toFixed(2) + '</p>' +
          '</div>' +
          '</div>' +
          '</div>' +
          '<form id="formRetiroLimite" onsubmit="procesarRetiroLimite(event)">' +
          '<div class="mb-4">' +
          '<label class="block text-sm font-medium text-gray-700 mb-2">Monto a Retirar ($)</label>' +
          '<input type="number" id="montoRetiroLimite" step="0.01" min="' + parseFloat(montoExcedente).toFixed(2) + '" required ' +
          'value="' + parseFloat(montoExcedente).toFixed(2) + '" ' +
          'class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-lg" ' +
          'placeholder="0.00" autofocus>' +
          '</div>' +
          '<div class="flex gap-3">' +
          '<button type="submit" class="flex-1 bg-primary-600 hover:bg-primary-700 text-white py-3 px-6 rounded-lg transition font-medium">' +
          '<i class="fas fa-money-bill-wave mr-2"></i>Realizar Retiro' +
          '</button>' +
          '<button type="button" onclick="cerrarModalRetiroLimite()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-6 rounded-lg transition font-medium">' +
          'Cancelar' +
          '</button>' +
          '</div>' +
          '</form>' +
          '</div>' +
          '</div>';

        document.body.appendChild(modal);

        // Guardar callback en el modal para usarlo después
        modal.callback = callback;

        // Guardar también en una variable global para acceso desde el form
        window.callbackRetiroLimite = callback;

        // Cerrar al hacer clic fuera
        modal.addEventListener('click', function (e) {
          if (e.target === modal) {
            cerrarModalRetiroLimite();
          }
        });

        // Focus en el input
        setTimeout(function () {
          const input = document.getElementById('montoRetiroLimite');
          if (input) {
            input.focus();
            input.select();
          }
        }, 100);
      }

      // Procesar retiro desde el modal de límite
      function procesarRetiroLimite(event) {
        event.preventDefault();

        const monto = parseFloat(document.getElementById('montoRetiroLimite').value);
        const callback = window.callbackRetiroLimite || function () { };

        if (!monto || monto <= 0) {
          mostrarNotificacion('error', 'Error', 'Debes ingresar un monto válido');
          return;
        }

        // Realizar retiro de efectivo directamente de la caja
        fetch('/pos/retirar-efectivo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            monto: monto.toFixed(2),
            observaciones: 'Retiro automático por límite de efectivo alcanzado'
          })
        })
          .then(function (response) { return response.json(); })
          .then(function (result) {
            if (result.success) {
              cerrarModalRetiroLimite();

              // Actualizar saldos después del retiro
              if (typeof actualizarSaldos === 'function') {
                actualizarSaldos();
              }

              // Verificar nuevamente el límite después del retiro
              setTimeout(function () {
                fetch('/pos/limite-efectivo')
                  .then(function (response) { return response.json(); })
                  .then(function (result) {
                    if (result.success) {
                      const saldoActual = parseFloat(result.saldoActual) || 0;
                      const limiteMaximo = parseFloat(result.limiteMaximo) || 0;

                      // Si aún se alcanza el límite, mostrar otro modal
                      if (limiteMaximo > 0 && saldoActual >= limiteMaximo) {
                        mostrarModalRetiro(saldoActual, limiteMaximo, saldoActual, callback);
                      } else {
                        // Ya no se alcanza el límite, ejecutar callback si existe
                        if (callback && typeof callback === 'function') {
                          callback();
                        }
                      }
                    } else {
                      // Si hay error, ejecutar callback si existe
                      if (callback && typeof callback === 'function') {
                        callback();
                      }
                    }
                  })
                  .catch(function (error) {
                    console.error('Error al verificar límite después del retiro:', error);
                    // Si hay error, ejecutar callback si existe
                    if (callback && typeof callback === 'function') {
                      callback();
                    }
                  });
              }, 500);
            } else {
              mostrarNotificacion('error', 'Error', result.error || 'No se pudo realizar el retiro');
            }
          })
          .catch(function (error) {
            console.error('Error al realizar retiro:', error);
            mostrarNotificacion('error', 'Error', 'No se pudo realizar el retiro');
          });
      }

      // Cerrar modal de retiro
      function cerrarModalRetiroLimite() {
        const modal = document.getElementById('modalRetiroLimite');
        if (modal) {
          modal.style.animation = 'fadeOut 0.2s ease-out';
          setTimeout(function () {
            modal.remove();
            window.callbackRetiroLimite = null;
          }, 200);
        }
      }

      function mostrarNotificacion(tipo, titulo, mensaje) {
        // Eliminar notificación anterior si existe
        var existente = document.getElementById('notificacionModal');
        if (existente) existente.remove();

        var iconos = {
          success: '<div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-check text-3xl text-green-500"></i></div>',
          error: '<div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-times text-3xl text-red-500"></i></div>',
          warning: '<div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-exclamation text-3xl text-amber-500"></i></div>',
          info: '<div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-info text-3xl text-blue-500"></i></div>',
          ok: '<div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-check text-3xl text-green-500"></i></div>'
        };

        var colores = {
          success: 'bg-green-500 hover:bg-green-600',
          error: 'bg-red-500 hover:bg-red-600',
          warning: 'bg-amber-500 hover:bg-amber-600',
          info: 'bg-blue-500 hover:bg-blue-600',
          ok: 'bg-green-500 hover:bg-green-600'
        };

        var modal = document.createElement('div');
        modal.id = 'notificacionModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.style.animation = 'fadeIn 0.2s ease-out';
        modal.innerHTML =
          '<div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden" style="animation: slideUp 0.3s ease-out">' +
          '<div class="p-6 text-center">' +
          iconos[tipo] +
          '<h3 class="text-xl font-bold text-gray-800 mb-2">' + titulo + '</h3>' +
          '<div class="text-gray-600">' + mensaje + '</div>' +
          '</div>' +
          '<div class="px-6 pb-6">' +
          '<button onclick="cerrarNotificacion()" class="w-full ' + colores[tipo] + ' text-white py-3 rounded-xl font-medium transition transform hover:scale-105">' +
          'Aceptar' +
          '</button>' +
          '</div>' +
          '</div>';

        document.body.appendChild(modal);

        // Cerrar al hacer clic fuera
        modal.addEventListener('click', function (e) {
          if (e.target === modal) cerrarNotificacion();
        });
      }

      function cerrarNotificacion() {
        var modal = document.getElementById('notificacionModal');
        if (modal) {
          modal.style.animation = 'fadeOut 0.2s ease-out';
          setTimeout(function () { modal.remove(); }, 200);
        }
      }

      function guardarSaldoInicial(event) {
        event.preventDefault();
        const saldo = parseFloat(document.getElementById('saldoInicial').value);
        const saldoPredefinido = parseFloat(document.getElementById('saldoInicial').getAttribute('min')) || 0;

        if (isNaN(saldo) || saldo < 0) {
          mostrarNotificacion('error', 'Error', 'Ingresa un saldo válido');
          return;
        }

        // Validar que el saldo no sea menor al predefinido (si existe)
        if (saldoPredefinido > 0 && saldo < saldoPredefinido) {
          mostrarNotificacion('error', 'Error',
            'El saldo inicial no puede ser menor a $' + saldoPredefinido.toFixed(2) + '. ' +
            'Si necesitas un saldo menor, realiza otro retiro primero.'
          );
          return;
        }

        // Permitir saldo cero solo si no hay saldo predefinido
        if (saldo === 0 && saldoPredefinido === 0) {
          // Confirmar si realmente quiere saldo cero
          if (!confirm('¿Confirmas que el saldo inicial es $0.00?')) {
            return;
          }
        }

        fetch('/pos/saldo-inicial', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ saldoInicial: saldo })
        })
          .then(function (response) {
            // Verificar si la respuesta es OK antes de parsear JSON
            if (!response.ok) {
              return response.json().then(function (errorData) {
                throw new Error(errorData.error || 'Error al guardar saldo inicial');
              }).catch(function () {
                throw new Error('Error al guardar saldo inicial. Código: ' + response.status);
              });
            }
            return response.json();
          })
          .then(function (result) {
            if (result.success) {
              // Actualizar saldos inmediatamente antes de redirigir
              if (typeof window.actualizarSaldos === 'function') {
                window.actualizarSaldos();
              }
              // Redirigir sin el parámetro necesitaSaldoInicial para evitar que se muestre de nuevo
              window.location.href = '/pos';
            } else {
              mostrarNotificacion('error', 'Error', result.error || 'No se pudo guardar el saldo inicial');
            }
          })
          .catch(function (error) {
            console.error('Error al guardar saldo inicial:', error);
            mostrarNotificacion('error', 'Error', error.message || 'Error al guardar saldo inicial. Por favor, verifica tu conexión e intenta nuevamente.');
          });
      }

      // Funcionalidad de Aplazos
      let pacientesEncontrados = [];
      let tratamientosSeleccionados = {};

      // Búsqueda de pacientes con debounce
      let timeoutBusqueda;
      document.addEventListener('DOMContentLoaded', function () {
        const buscarInput = document.getElementById('buscarPacienteAplazos');
        if (buscarInput) {
          buscarInput.addEventListener('input', function () {
            clearTimeout(timeoutBusqueda);
            const query = this.value.trim();

            if (query.length < 2) {
              document.getElementById('listaResultadosPacientes').classList.add('hidden');
              document.getElementById('tratamientosPaciente').classList.add('hidden');
              document.getElementById('sinTratamientos').classList.add('hidden');
              return;
            }

            timeoutBusqueda = setTimeout(function () {
              buscarPacientes(query);
            }, 300);
          });
        }

        // Cerrar lista de resultados al hacer clic fuera
        document.addEventListener('click', function (e) {
          const listaResultados = document.getElementById('listaResultadosPacientes');
          const buscarInput = document.getElementById('buscarPacienteAplazos');
          if (listaResultados && buscarInput && !listaResultados.contains(e.target) && e.target !== buscarInput) {
            listaResultados.classList.add('hidden');
          }
        });
      });

      async function buscarPacientes(query) {
        try {
          const response = await fetch('/aplazos/buscar-pacientes?q=' + encodeURIComponent(query));
          const pacientes = await response.json();

          pacientesEncontrados = pacientes;
          const listaResultados = document.getElementById('listaResultadosPacientes');

          if (pacientes.length === 0) {
            listaResultados.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 text-center">No se encontraron pacientes</div>';
            listaResultados.classList.remove('hidden');
            return;
          }

          listaResultados.innerHTML = '';

          pacientes.forEach(function (p) {
            const item = document.createElement('div');
            item.className = 'px-4 py-3 hover:bg-primary-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors';
            item.innerHTML = '<div class="font-medium text-gray-800">' + p.nombre + ' ' + p.apellido + '</div>';
            item.addEventListener('click', function () {
              seleccionarPacienteAplazos(p);
            });
            listaResultados.appendChild(item);
          });

          listaResultados.classList.remove('hidden');
        } catch (error) {
          console.error('Error al buscar pacientes:', error);
          mostrarNotificacion('error', 'Error', 'Error al buscar pacientes');
        }
      }

      async function seleccionarPacienteAplazos(paciente) {
        // Ocultar lista de resultados
        document.getElementById('listaResultadosPacientes').classList.add('hidden');
        document.getElementById('buscarPacienteAplazos').value = paciente.nombre + ' ' + paciente.apellido;

        // Cargar tratamientos del paciente
        await cargarTratamientosPaciente(paciente.id);

        // Actualizar campos de paciente y doctor en el carrito
        const pacienteHidden = document.getElementById('pacienteVenta');
        const doctorHidden = document.getElementById('doctorVenta');

        if (pacienteHidden) {
          pacienteHidden.value = paciente.id;
          // Actualizar el input de búsqueda también
          const pacienteSearch = document.getElementById('pacienteVenta_search');
          if (pacienteSearch) {
            pacienteSearch.value = paciente.nombre + ' ' + paciente.apellido;
          }
        }

        // Obtener información del doctor del primer tratamiento
        try {
          const response = await fetch('/aplazos/paciente/' + paciente.id + '/tratamientos');
          const tratamientos = await response.json();

          if (tratamientos.length > 0 && tratamientos[0].doctor && doctorHidden) {
            const doctor = tratamientos[0].doctor;
            doctorHidden.value = doctor.id;
            // Actualizar el input de búsqueda también
            const doctorSearch = document.getElementById('doctorVenta_search');
            if (doctorSearch) {
              doctorSearch.value = 'Dr. ' + doctor.nombre + ' ' + doctor.apellido;
            }
          }
        } catch (error) {
          console.error('Error al obtener tratamientos:', error);
        }

        mostrarNotificacion('success', 'Paciente Seleccionado', 'El paciente y su doctor han sido seleccionados en el carrito');
      }

      async function cargarTratamientosPaciente(pacienteId) {
        try {
          const response = await fetch('/aplazos/paciente/' + pacienteId + '/tratamientos');
          const tratamientos = await response.json();

          const contenedor = document.getElementById('listaTratamientos');
          contenedor.innerHTML = '';

          if (tratamientos.length === 0) {
            document.getElementById('tratamientosPaciente').classList.add('hidden');
            document.getElementById('sinTratamientos').classList.remove('hidden');
            return;
          }

          document.getElementById('tratamientosPaciente').classList.remove('hidden');
          document.getElementById('sinTratamientos').classList.add('hidden');

          tratamientos.forEach(function (t, index) {
            const montoTotal = parseFloat(t.montoTotal);
            const montoPagado = parseFloat(t.montoPagado);
            const montoAdeudado = parseFloat(t.montoAdeudado);
            const porcentajePagado = montoTotal > 0 ? (montoPagado / montoTotal * 100).toFixed(0) : 0;
            const fechaCreacion = new Date(t.createdAt).toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric' });

            const card = document.createElement('div');
            card.setAttribute('class', 'bg-white border border-gray-200 rounded-lg p-4 mb-4');
            card.innerHTML =
              '<div class="mb-3 pb-3 border-b border-gray-200">' +
              '<div class="flex justify-between items-start mb-1">' +
              '<h4 class="font-bold text-gray-800">' + t.servicio.nombre + '</h4>' +
              '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">Tratamiento #' + (index + 1) + '</span>' +
              '</div>' +
              '<p class="text-sm text-gray-600 mb-1">Dr. ' + t.doctor.nombre + ' ' + t.doctor.apellido + '</p>' +
              '<p class="text-xs text-gray-500">Registrado: ' + fechaCreacion + '</p>' +
              '</div>' +
              '<div class="mb-3">' +
              '<div class="flex justify-between text-sm mb-1">' +
              '<span class="text-gray-600">Monto Total:</span>' +
              '<span class="font-bold text-gray-800">' + formatCurrency(montoTotal) + '</span>' +
              '</div>' +
              '<div class="flex justify-between text-sm mb-1">' +
              '<span class="text-gray-600">Pagado:</span>' +
              '<span class="font-bold text-green-600">' + formatCurrency(montoPagado) + '</span>' +
              '</div>' +
              '<div class="flex justify-between text-sm mb-2">' +
              '<span class="text-gray-600">Adeudo:</span>' +
              '<span class="font-bold text-red-600">' + formatCurrency(montoAdeudado) + '</span>' +
              '</div>' +
              '<div class="w-full bg-gray-200 rounded-full h-2 mb-3">' +
              '<div class="bg-green-500 h-2 rounded-full" style="width: ' + porcentajePagado + '%"></div>' +
              '</div>' +
              '</div>' +
              '<div class="mb-3">' +
              '<label class="block text-xs font-medium text-gray-700 mb-1">Monto del Abono</label>' +
              '<input type="number" step="0.01" min="0.01" max="' + montoAdeudado + '" ' +
              'id="montoAbono_' + t.id + '" ' +
              'class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500" ' +
              'placeholder="Ingresa el monto del abono">' +
              '</div>' +
              '<button onclick="registrarAbono(' + t.id + ', ' + pacienteId + ', ' + montoAdeudado + ', \'' + (t.servicio.nombre || '').replace(/'/g, "\\'") + '\', ' + (t.doctorId || t.doctor.id || 'null') + ')" ' +
              'class="w-full bg-primary-600 text-white py-2 rounded-lg hover:bg-primary-700 transition text-sm font-medium">' +
              'Agregar al carrito' +
              '</button>' +
              '<button onclick="verHistorialAbonos(' + t.id + ')" ' +
              'class="w-full mt-2 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition text-sm font-medium">' +
              'Ver Historial' +
              '</button>';
            contenedor.appendChild(card);
          });
        } catch (error) {
          console.error('Error al cargar tratamientos:', error);
          mostrarNotificacion('error', 'Error', 'Error al cargar tratamientos');
        }
      }

      // Cargar pacientes con tratamientos pendientes
      let pendientesAplazos = [];

      async function cargarPendientesAplazos() {
        console.log('cargarPendientesAplazos llamada');
        const grid = document.getElementById('gridPacientesPendientes');
        const contenedorDetalle = document.getElementById('listaPendientesAplazos');

        if (!grid) {
          console.error('gridPacientesPendientes no encontrado en el DOM');
          return;
        }

        console.log('Iniciando carga de pendientes...');
        grid.innerHTML = '<p class="text-gray-400 text-xs italic col-span-full">Cargando pacientes con deuda...</p>';
        const fmtMoney = (v) => '$' + parseFloat(v || 0).toFixed(2);

        try {
          console.log('Haciendo fetch a /aplazos/pendientes...');
          const res = await fetch('/aplazos/pendientes');

          if (!res.ok) {
            throw new Error('Error al obtener pendientes: ' + res.status);
          }

          const data = await res.json();
          const pendientes = Array.isArray(data) ? data : [];

          if (!pendientes.length) {
            grid.innerHTML = '<p class="text-gray-500 text-xs italic col-span-full text-center py-4">No hay pacientes con deuda pendiente</p>';
            return;
          }

          // Agrupar por paciente
          const pacientesConDeuda = {};
          pendientes.forEach(p => {
            if (!p.paciente) return;
            const pid = p.paciente.id;
            if (!pacientesConDeuda[pid]) {
              pacientesConDeuda[pid] = {
                id: pid,
                nombre: p.paciente.nombre + ' ' + p.paciente.apellido,
                totalAdeudado: 0,
                cantidadTratamientos: 0,
                pacienteRaw: p.paciente
              };
            }
            pacientesConDeuda[pid].totalAdeudado += parseFloat(p.montoAdeudado || 0);
            pacientesConDeuda[pid].cantidadTratamientos++;
          });

          // Llenar el grid
          grid.innerHTML = '';
          Object.values(pacientesConDeuda).sort((a, b) => b.totalAdeudado - a.totalAdeudado).forEach(p => {
            const card = document.createElement('div');
            card.className = 'bg-white border border-gray-200 rounded-lg p-3 hover:border-primary-500 hover:shadow-md transition-all cursor-pointer group';
            card.onclick = () => {
              seleccionarPacienteAplazos(p.pacienteRaw);
              // Hacer scroll suave hacia el área de tratamientos si es necesario
              document.getElementById('tratamientosPaciente').scrollIntoView({ behavior: 'smooth', block: 'start' });
            };

            card.innerHTML =
              '<div class="flex justify-between items-start">' +
              '<div>' +
              '<p class="text-sm font-bold text-gray-800 group-hover:text-primary-600 transition-colors">' + p.nombre + '</p>' +
              '<p class="text-xs text-gray-500">' + p.cantidadTratamientos + ' tratamiento(s) pendiente(s)</p>' +
              '</div>' +
              '<div class="text-right">' +
              '<p class="text-xs text-gray-400 font-medium">Deuda Total</p>' +
              '<p class="text-sm font-bold text-red-600">' + fmtMoney(p.totalAdeudado) + '</p>' +
              '</div>' +
              '</div>';
            grid.appendChild(card);
          });

        } catch (error) {
          console.error('Error al cargar pendientes:', error);
          grid.innerHTML = '<p class="text-red-500 text-xs col-span-full">Error: ' + error.message + '</p>';
        }
      }

      function mostrarDetallePendiente(tratamientoId) {
        const contenedor = document.getElementById('listaPendientesAplazos');
        if (!contenedor) return;

        if (!tratamientoId) {
          contenedor.innerHTML = '<p class="text-gray-400 text-xs">Selecciona un tratamiento de la lista para ver detalles</p>';
          return;
        }

        const pendiente = pendientesAplazos.find(p => p.id === parseInt(tratamientoId));
        if (!pendiente) {
          contenedor.innerHTML = '<p class="text-red-500 text-xs">Tratamiento no encontrado</p>';
          return;
        }

        const fmtMoney = (v) => '$' + parseFloat(v || 0).toFixed(2);
        const pacienteNombre = pendiente.paciente ? (pendiente.paciente.nombre + ' ' + pendiente.paciente.apellido) : 'Paciente';
        const doctorNombre = pendiente.doctor ? ('Dr. ' + pendiente.doctor.nombre + ' ' + pendiente.doctor.apellido) : 'Doctor';
        const servicioNombre = pendiente.servicio ? pendiente.servicio.nombre : 'Tratamiento';
        const adeudo = parseFloat(pendiente.montoAdeudado || 0);
        const creado = new Date(pendiente.createdAt).toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric' });

        contenedor.innerHTML = (
          '<div class="border border-gray-200 rounded-lg p-3 flex flex-col gap-2 bg-gray-50">' +
          '<div class="flex justify-between items-start">' +
          '<div>' +
          '<p class="text-sm font-semibold text-gray-800">' + pacienteNombre + '</p>' +
          '<p class="text-xs text-gray-500">' + doctorNombre + '</p>' +
          '<p class="text-xs text-gray-500">' + servicioNombre + '</p>' +
          '</div>' +
          '<div class="text-right">' +
          '<p class="text-xs text-gray-500">Adeudo</p>' +
          '<p class="text-sm font-bold text-red-600">' + fmtMoney(adeudo) + '</p>' +
          '</div>' +
          '</div>' +
          '<div class="flex justify-between items-center text-xs text-gray-500">' +
          '<span>Registrado: ' + creado + '</span>' +
          '</div>' +
          '<button class="w-full bg-primary-600 text-white py-2 rounded-lg hover:bg-primary-700 transition text-sm font-medium" ' +
          'onclick="seleccionarPendienteAplazo(' + pendiente.id + ')">' +
          'Seleccionar y registrar abono' +
          '</button>' +
          '</div>'
        );
      }

      // Exponer temprano las funciones para evitar que el stub bloquee
      window._cargarPendientesAplazosImpl = cargarPendientesAplazos;
      window.cargarPendientesAplazos = cargarPendientesAplazos;
      window.seleccionarPendienteAplazo = seleccionarPendienteAplazo;
      window.mostrarDetallePendiente = mostrarDetallePendiente;

      function seleccionarPendienteAplazo(tratamientoId) {
        const pendiente = pendientesAplazos.find(p => p.id === tratamientoId);
        if (!pendiente) return;
        const paciente = pendiente.paciente;
        const doctor = pendiente.doctor;

        // Setear paciente
        const pacienteHidden = document.getElementById('pacienteVenta');
        const pacienteSearch = document.getElementById('pacienteVenta_search');
        if (pacienteHidden) pacienteHidden.value = paciente ? paciente.id : '';
        if (pacienteSearch && paciente) pacienteSearch.value = paciente.nombre + ' ' + paciente.apellido;

        // Setear doctor
        const doctorHidden = document.getElementById('doctorVenta');
        const doctorSearch = document.getElementById('doctorVenta_search');
        if (doctorHidden) doctorHidden.value = doctor ? doctor.id : '';
        if (doctorSearch && doctor) doctorSearch.value = 'Dr. ' + doctor.nombre + ' ' + doctor.apellido;

        // Mostrar tratamientos del paciente
        if (paciente) {
          const buscarInput = document.getElementById('buscarPacienteAplazos');
          if (buscarInput) buscarInput.value = paciente.nombre + ' ' + paciente.apellido;
          cargarTratamientosPaciente(paciente.id);
        }

        mostrarNotificacion('info', 'Paciente seleccionado', 'Ahora puedes registrar el abono en el listado inferior.');
      }

      // Event listeners para la lista desplegable
      document.addEventListener('DOMContentLoaded', function () {
        const select = document.getElementById('selectPendientesAplazos');
        const btnActualizar = document.getElementById('btnActualizarPendientes');

        const gridDisplay = document.getElementById('gridPacientesPendientes');
        if (gridDisplay) {
          // No necesitamos listener de change para el grid
        }

        if (btnActualizar) {
          btnActualizar.addEventListener('click', function () {
            if (typeof cargarPendientesAplazos === 'function') {
              cargarPendientesAplazos();
            } else if (window.cargarPendientesAplazos) {
              window.cargarPendientesAplazos();
            }
          });
        }

        setTimeout(function () {
          const contenedorAplazos = document.getElementById('contenedorAplazos');
          // Siempre intentar cargar por si acaso la pestaña se muestra después o ya está visible
          console.log('Iniciando carga automática de pendientes...');
          if (typeof cargarPendientesAplazos === 'function') {
            cargarPendientesAplazos();
          } else if (window.cargarPendientesAplazos && typeof window.cargarPendientesAplazos === 'function') {
            window.cargarPendientesAplazos();
          }
        }, 500);
      });

      async function registrarAbono(tratamientoId, pacienteId, adeudoDisponible, servicioNombre, doctorId) {
        const montoInput = document.getElementById('montoAbono_' + tratamientoId);
        const monto = parseFloat(montoInput.value);

        if (!monto || monto <= 0) {
          mostrarNotificacion('error', 'Error', 'Ingresa un monto válido');
          return;
        }

        if (monto > adeudoDisponible) {
          mostrarNotificacion('error', 'Error', 'El abono no puede ser mayor al adeudo');
          return;
        }

        try {
          // Solo agregar al carrito; se procesará al cobrar
          const item = {
            tipo: 'abono',
            tratamientoPlazoId: tratamientoId,
            nombre: 'Abono - ' + (servicioNombre || 'Tratamiento'),
            precio: monto,
            cantidad: 1,
            pacienteId: pacienteId,
            doctorId: doctorId || null,
          };

          carrito.push(item);
          renderCarrito();

          // Limpiar el campo de monto
          montoInput.value = '';

          // Refrescar adeudos en UI
          cargarTratamientosPaciente(pacienteId);

          mostrarNotificacion('ok', 'Agregado al carrito', 'El abono se aplicará al cobrar.');
        } catch (error) {
          console.error('Error al registrar abono:', error);
          mostrarNotificacion('error', 'Error', 'No se pudo agregar el abono al carrito');
        }
      }

      // Legacy: mantener función por si se usa en algún flujo previo
      function agregarAbonoAlCarrito(abono) {
        if (!abono) return;
        const tratamiento = abono.tratamientoPlazo || {};
        const servicioNombre = (tratamiento.servicio && tratamiento.servicio.nombre)
          ? tratamiento.servicio.nombre.replace(/'/g, "\\'")
          : (abono.servicioNombre ? abono.servicioNombre.replace(/'/g, "\\'") : 'Tratamiento');
        const item = {
          tipo: 'abono',
          tratamientoPlazoId: tratamiento.id || abono.tratamientoPlazoId,
          abonoId: abono.id,
          nombre: 'Abono - ' + servicioNombre,
          precio: parseFloat(abono.monto || abono.precio || 0),
          cantidad: 1,
          pacienteId: tratamiento.pacienteId || abono.pacienteId,
          doctorId: tratamiento.doctorId || abono.doctorId || null,
        };

        carrito.push(item);
        renderCarrito();
      }

      async function verHistorialAbonos(tratamientoId) {
        try {
          const response = await fetch('/aplazos/tratamiento/' + tratamientoId + '/abonos');
          const abonos = await response.json();

          let historialHTML = '<div class="space-y-2">';
          abonos.forEach(function (a) {
            historialHTML +=
              '<div class="bg-gray-50 border border-gray-200 rounded p-3 text-sm">' +
              '<div class="flex justify-between mb-1">' +
              '<span class="font-medium">' + formatCurrency(a.monto) + '</span>' +
              '<span class="text-gray-500">' + new Date(a.createdAt).toLocaleDateString() + '</span>' +
              '</div>' +
              '<div class="text-xs text-gray-600">' +
              'Saldo anterior: ' + formatCurrency(a.saldoAnterior) + ' → Saldo nuevo: ' + formatCurrency(a.saldoNuevo) +
              '</div>' +
              '</div>';
          });
          historialHTML += '</div>';

          mostrarNotificacion('info', 'Historial de Abonos', historialHTML);
        } catch (error) {
          console.error('Error al cargar historial:', error);
          mostrarNotificacion('error', 'Error', 'Error al cargar historial');
        }
      }

    </script>

    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }

        to {
          opacity: 0;
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }

        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Asegurar que el scroll interno funcione correctamente - igual que el sidebar */
      #listaServicios,
      #listaProductos {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        /* El scrollbar se mostrará automáticamente cuando el contenido exceda la altura */
      }

      /* Forzar 3 columnas siempre */
      #listaServicios>div,
      #listaProductos>div {
        display: grid !important;
        grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
        gap: 0.375rem !important;
      }

      /* Asegurar que las tarjetas ocupen todo el ancho disponible */
      #listaServicios [data-tipo],
      #listaProductos [data-tipo] {
        width: 100% !important;
        max-width: 100% !important;
      }
    </style>