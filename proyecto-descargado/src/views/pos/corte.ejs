<%
// Preparar variables antes del include para evitar problemas de parsing
const tipoCorteStr = tipoCorte || "";
const urlStr = esManual ? "/pos/corte-manual" : "/pos/corte";
const horaStr = hora || "";
const saldoEsperadoStr = resumen.saldoEsperado || 0;
const tipoCorteJson = JSON.stringify(tipoCorteStr);
const urlStrJson = JSON.stringify(urlStr);
const horaStrJson = JSON.stringify(horaStr);
const saldoEsperadoJson = JSON.stringify(parseFloat(resumen.saldoEsperado) || 0);
// Inicializar pagosLaboratorios si no está definido (para evitar errores en producción)
if (typeof pagosLaboratorios === 'undefined') {
  var pagosLaboratorios = [];
}
%>
<%- include('../layout', { body: `
<div class="max-w-4xl mx-auto">
  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">
          ${tipoCorte === 'efectivo' ? '<i class="fas fa-money-bill-wave text-green-500 mr-2"></i>Corte de Efectivo' : 
            tipoCorte === 'bancos' ? '<i class="fas fa-university text-blue-500 mr-2"></i>Corte de Bancos' :
            esManual ? '<i class="fas fa-cut text-red-500 mr-2"></i>Corte Manual de Caja' : 'Corte de Caja - ' + hora}
        </h2>
        <p class="text-gray-600">${now().format('DD/MM/YYYY HH:mm')}</p>
        ${esManual ? '<p class="text-sm text-amber-600 mt-1"><i class="fas fa-info-circle mr-1"></i>Corte realizado manualmente</p>' : ''}
      </div>
      <a href="/pos" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times text-2xl"></i>
      </a>
    </div>

    ${tipoCorte === 'efectivo' ? 
      '<!-- Resumen Efectivo -->' +
      '<div class="grid md:grid-cols-2 gap-4 mb-6">' +
        '<div class="bg-primary-50 rounded-lg p-4 border-l-4 border-primary-500">' +
          '<p class="text-sm text-gray-600 mb-1">Saldo Inicial Efectivo</p>' +
          '<p class="text-2xl font-bold text-primary-600">' + formatCurrency(resumen.saldoInicialEfectivo) + '</p>' +
        '</div>' +
        '<div class="bg-secondary-50 rounded-lg p-4 border-l-4 border-secondary-500">' +
          '<p class="text-sm text-gray-600 mb-1">Total Ventas en Efectivo</p>' +
          '<p class="text-2xl font-bold text-secondary-600">' + formatCurrency(resumen.ventasEfectivo) + '</p>' +
          '<p class="text-xs text-gray-500 mt-1">' + resumen.cantidadVentas + ' venta(s)</p>' +
        '</div>' +
      '</div>' +
      ((resumen.totalRetiros && resumen.totalRetiros > 0) ? 
        '<div class="bg-amber-50 rounded-lg p-4 mb-4 border-l-4 border-amber-500">' +
          '<p class="text-sm text-gray-600 mb-1">Retiros de Efectivo</p>' +
          '<p class="text-2xl font-bold text-amber-600">' + formatCurrency(resumen.totalRetiros) + '</p>' +
        '</div>' 
      : '') +
      ((resumen.totalPagosLaboratorios && resumen.totalPagosLaboratorios > 0) ? 
        '<div class="bg-purple-50 rounded-lg p-4 mb-4 border-l-4 border-purple-500">' +
          '<p class="text-sm text-gray-600 mb-1">Pagos a Laboratorios</p>' +
          '<p class="text-2xl font-bold text-purple-600">' + formatCurrency(resumen.totalPagosLaboratorios) + '</p>' +
        '</div>' 
      : '') +
      (resumen.gastosEfectivo > 0 ? 
        '<div class="bg-red-50 rounded-lg p-4 mb-6 border-l-4 border-red-500">' +
          '<p class="text-sm text-gray-600 mb-1">Gastos en Efectivo</p>' +
          '<p class="text-2xl font-bold text-red-600">' + formatCurrency(resumen.gastosEfectivo) + '</p>' +
        '</div>' 
      : '') +
      '<!-- Saldo esperado -->' +
      '<div class="bg-amber-50 rounded-lg p-4 mb-6 border-l-4 border-amber-500">' +
        '<p class="text-sm text-gray-600 mb-1">Saldo Esperado en Caja</p>' +
        '<p class="text-3xl font-bold text-amber-600">' + formatCurrency(resumen.saldoEsperado) + '</p>' +
        '<p class="text-xs text-gray-500 mt-1">Saldo Inicial + Ventas en Efectivo - Gastos en Efectivo</p>' +
      '</div>' 
    : tipoCorte === 'bancos' ? 
      '<!-- Resumen Bancos -->' +
      '<div class="grid md:grid-cols-3 gap-4 mb-6">' +
        '<div class="bg-green-50 rounded-lg p-4 border-l-4 border-green-500">' +
          '<p class="text-sm text-gray-600 mb-1">Azteca</p>' +
          '<p class="text-lg font-bold text-green-600 mb-2">Saldo Inicial: ' + formatCurrency(resumen.saldoInicialTarjetaAzteca + resumen.saldoInicialTransferenciaAzteca) + '</p>' +
          '<p class="text-sm text-gray-600">Ventas: ' + formatCurrency(resumen.ventasTarjetaAzteca + resumen.ventasTransferenciaAzteca) + '</p>' +
          ((resumen.gastosTarjetaAzteca + resumen.gastosTransferenciaAzteca) > 0 ? '<p class="text-sm text-red-600">Gastos: ' + formatCurrency(resumen.gastosTarjetaAzteca + resumen.gastosTransferenciaAzteca) + '</p>' : '') +
          '<p class="text-lg font-bold text-green-700 mt-2">Esperado: ' + formatCurrency(resumen.saldoEsperadoAzteca) + '</p>' +
        '</div>' +
        '<div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">' +
          '<p class="text-sm text-gray-600 mb-1">BBVA</p>' +
          '<p class="text-lg font-bold text-blue-600 mb-2">Saldo Inicial: ' + formatCurrency(resumen.saldoInicialTarjetaBbva + resumen.saldoInicialTransferenciaBbva) + '</p>' +
          '<p class="text-sm text-gray-600">Ventas: ' + formatCurrency(resumen.ventasTarjetaBbva + resumen.ventasTransferenciaBbva) + '</p>' +
          ((resumen.gastosTarjetaBbva + resumen.gastosTransferenciaBbva) > 0 ? '<p class="text-sm text-red-600">Gastos: ' + formatCurrency(resumen.gastosTarjetaBbva + resumen.gastosTransferenciaBbva) + '</p>' : '') +
          '<p class="text-lg font-bold text-blue-700 mt-2">Esperado: ' + formatCurrency(resumen.saldoEsperadoBbva) + '</p>' +
        '</div>' +
        '<div class="bg-indigo-50 rounded-lg p-4 border-l-4 border-indigo-500">' +
          '<p class="text-sm text-gray-600 mb-1">Mercado Pago</p>' +
          '<p class="text-lg font-bold text-indigo-600 mb-2">Saldo Inicial: ' + formatCurrency(resumen.saldoInicialTarjetaMp + resumen.saldoInicialTransferenciaMp) + '</p>' +
          '<p class="text-sm text-gray-600">Ventas: ' + formatCurrency(resumen.ventasTarjetaMp + resumen.ventasTransferenciaMp) + '</p>' +
          ((resumen.gastosTarjetaMp + resumen.gastosTransferenciaMp) > 0 ? '<p class="text-sm text-red-600">Gastos: ' + formatCurrency(resumen.gastosTarjetaMp + resumen.gastosTransferenciaMp) + '</p>' : '') +
          '<p class="text-lg font-bold text-indigo-700 mt-2">Esperado: ' + formatCurrency(resumen.saldoEsperadoMp) + '</p>' +
        '</div>' +
      '</div>' 
    : 
      '<!-- Resumen General -->' +
      '<div class="grid md:grid-cols-2 gap-4 mb-6">' +
        '<div class="bg-primary-50 rounded-lg p-4 border-l-4 border-primary-500">' +
          '<p class="text-sm text-gray-600 mb-1">Saldo Inicial</p>' +
          '<p class="text-2xl font-bold text-primary-600">' + formatCurrency(resumen.saldoInicial) + '</p>' +
        '</div>' +
        '<div class="bg-secondary-50 rounded-lg p-4 border-l-4 border-secondary-500">' +
          '<p class="text-sm text-gray-600 mb-1">Total Ventas</p>' +
          '<p class="text-2xl font-bold text-secondary-600">' + formatCurrency(resumen.totalVentas) + '</p>' +
          '<p class="text-xs text-gray-500 mt-1">' + resumen.cantidadVentas + ' venta(s)</p>' +
        '</div>' +
      '</div>' +
      '<!-- Desglose por método de pago -->' +
      '<div class="grid md:grid-cols-3 gap-4 mb-6">' +
        '<div class="bg-green-50 rounded-lg p-4">' +
          '<p class="text-sm text-gray-600 mb-1">Efectivo</p>' +
          '<p class="text-xl font-bold text-green-600">' + formatCurrency(resumen.ventasEfectivo) + '</p>' +
        '</div>' +
        '<div class="bg-blue-50 rounded-lg p-4">' +
          '<p class="text-sm text-gray-600 mb-1">Tarjeta</p>' +
          '<p class="text-xl font-bold text-blue-600">' + formatCurrency(resumen.ventasTarjeta) + '</p>' +
          (resumen.ventasTarjeta > 0 ? 
            '<div class="mt-2 pt-2 border-t border-blue-200 text-xs">' +
              (resumen.ventasTarjetaAzteca > 0 ? '<p class="text-blue-700">Azteca: ' + formatCurrency(resumen.ventasTarjetaAzteca) + '</p>' : '') +
              (resumen.ventasTarjetaBbva > 0 ? '<p class="text-blue-700">BBVA: ' + formatCurrency(resumen.ventasTarjetaBbva) + '</p>' : '') +
              (resumen.ventasTarjetaMp > 0 ? '<p class="text-blue-700">Mercado Pago: ' + formatCurrency(resumen.ventasTarjetaMp) + '</p>' : '') +
            '</div>' 
          : '') +
        '</div>' +
        '<div class="bg-purple-50 rounded-lg p-4">' +
          '<p class="text-sm text-gray-600 mb-1">Transferencia</p>' +
          '<p class="text-xl font-bold text-purple-600">' + formatCurrency(resumen.ventasTransferencia) + '</p>' +
          (resumen.ventasTransferencia > 0 ? 
            '<div class="mt-2 pt-2 border-t border-purple-200 text-xs">' +
              (resumen.ventasTransferenciaAzteca > 0 ? '<p class="text-purple-700">Azteca: ' + formatCurrency(resumen.ventasTransferenciaAzteca) + '</p>' : '') +
              (resumen.ventasTransferenciaBbva > 0 ? '<p class="text-purple-700">BBVA: ' + formatCurrency(resumen.ventasTransferenciaBbva) + '</p>' : '') +
              (resumen.ventasTransferenciaMp > 0 ? '<p class="text-purple-700">Mercado Pago: ' + formatCurrency(resumen.ventasTransferenciaMp) + '</p>' : '') +
            '</div>' 
          : '') +
        '</div>' +
      '</div>' +
      '<!-- Saldo esperado -->' +
      '<div class="bg-amber-50 rounded-lg p-4 mb-6 border-l-4 border-amber-500">' +
        '<p class="text-sm text-gray-600 mb-1">Saldo Esperado en Caja</p>' +
        '<p class="text-3xl font-bold text-amber-600">' + formatCurrency(resumen.saldoEsperado) + '</p>' +
        '<p class="text-xs text-gray-500 mt-1">Saldo Inicial + Ventas en Efectivo</p>' +
      '</div>'
    }

    <!-- Reporte Detallado -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">
        <i class="fas fa-file-alt text-primary-500 mr-2"></i>Reporte Detallado del Período
      </h3>
      
      <!-- Saldo Inicial -->
      <div class="mb-6 pb-6 border-b">
        <h4 class="text-md font-semibold text-gray-700 mb-3">Saldo Inicial</h4>
        <p class="text-2xl font-bold text-primary-600">${formatCurrency(resumen.saldoInicial)}</p>
        <p class="text-xs text-gray-500 mt-1">${moment(desdeFecha).tz(config.timezone).format('DD/MM/YYYY HH:mm')}</p>
      </div>

      <!-- Ventas por Doctor -->
      ${ventasPorDoctor && ventasPorDoctor.length > 0 ? 
        '<div class="mb-6 pb-6 border-b">' +
          '<h4 class="text-md font-semibold text-gray-700 mb-4">Ventas por Doctor</h4>' +
          '<div class="space-y-4">' +
            ventasPorDoctor.map(function(doc) {
              const totalDoc = doc.efectivo + doc.tarjeta.total + doc.transferencia.total;
              return '<div class="bg-gray-50 rounded-lg p-4">' +
                '<div class="flex justify-between items-start mb-3">' +
                  '<h5 class="font-semibold text-gray-800">' + doc.doctorNombre + '</h5>' +
                  '<span class="text-lg font-bold text-primary-600">' + formatCurrency(totalDoc) + '</span>' +
                '</div>' +
                '<div class="grid md:grid-cols-3 gap-3 text-sm">' +
                  '<div>' +
                    '<p class="text-gray-600 mb-1">Efectivo</p>' +
                    '<p class="font-semibold text-green-600">' + formatCurrency(doc.efectivo) + '</p>' +
                  '</div>' +
                  '<div>' +
                    '<p class="text-gray-600 mb-1">Tarjeta</p>' +
                    '<p class="font-semibold text-blue-600">' + formatCurrency(doc.tarjeta.total) + '</p>' +
                    (doc.tarjeta.total > 0 ? 
                      '<div class="mt-1 text-xs text-gray-500">' +
                        (doc.tarjeta.Azteca > 0 ? '<p>• Azteca: ' + formatCurrency(doc.tarjeta.Azteca) + '</p>' : '') +
                        (doc.tarjeta.BBVA > 0 ? '<p>• BBVA: ' + formatCurrency(doc.tarjeta.BBVA) + '</p>' : '') +
                        (doc.tarjeta['Mercado Pago'] > 0 ? '<p>• Mercado Pago: ' + formatCurrency(doc.tarjeta['Mercado Pago']) + '</p>' : '') +
                      '</div>' 
                    : '') +
                  '</div>' +
                  '<div>' +
                    '<p class="text-gray-600 mb-1">Transferencia</p>' +
                    '<p class="font-semibold text-purple-600">' + formatCurrency(doc.transferencia.total) + '</p>' +
                    (doc.transferencia.total > 0 ? 
                      '<div class="mt-1 text-xs text-gray-500">' +
                        (doc.transferencia.Azteca > 0 ? '<p>• Azteca: ' + formatCurrency(doc.transferencia.Azteca) + '</p>' : '') +
                        (doc.transferencia.BBVA > 0 ? '<p>• BBVA: ' + formatCurrency(doc.transferencia.BBVA) + '</p>' : '') +
                        (doc.transferencia['Mercado Pago'] > 0 ? '<p>• Mercado Pago: ' + formatCurrency(doc.transferencia['Mercado Pago']) + '</p>' : '') +
                      '</div>' 
                    : '') +
                  '</div>' +
                '</div>' +
              '</div>';
            }).join('') +
          '</div>' +
        '</div>' 
      : ''}

      <!-- Retiros del Período -->
      ${retiros && retiros.length > 0 ? 
        '<div class="mb-4">' +
          '<h4 class="text-md font-semibold text-gray-700 mb-4 flex items-center gap-2">' +
            '<i class="fas fa-hand-holding-usd text-amber-500"></i>' +
            'Retiros de Efectivo del Período' +
          '</h4>' +
          '<div class="overflow-x-auto">' +
            '<table class="w-full text-sm">' +
              '<thead class="bg-amber-50">' +
                '<tr>' +
                  '<th class="px-4 py-2 text-left text-gray-600">Fecha</th>' +
                  '<th class="px-4 py-2 text-left text-gray-600">Monto</th>' +
                  '<th class="px-4 py-2 text-left text-gray-600">Observaciones</th>' +
                  '<th class="px-4 py-2 text-left text-gray-600">Realizado por</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody class="divide-y divide-gray-100">' +
                retiros.map(function(r) {
                  return '<tr class="hover:bg-amber-50">' +
                    '<td class="px-4 py-2 text-gray-600">' + moment(r.createdAt).tz(config.timezone).format('DD/MM/YYYY HH:mm') + '</td>' +
                    '<td class="px-4 py-2 text-right font-semibold text-amber-600">' + formatCurrency(r.monto) + '</td>' +
                    '<td class="px-4 py-2 text-gray-600">' + (r.observaciones || '-') + '</td>' +
                    '<td class="px-4 py-2 text-gray-600">' + (r.usuario ? r.usuario.nombre : 'Sistema') + '</td>' +
                  '</tr>';
                }).join('') +
              '</tbody>' +
              '<tfoot class="bg-amber-50">' +
                '<tr>' +
                  '<td colspan="1" class="px-4 py-2 text-right font-semibold text-gray-700">Total de Retiros:</td>' +
                  '<td class="px-4 py-2 text-right font-bold text-amber-600">' + formatCurrency(retiros.reduce(function(sum, r) { return sum + parseFloat(r.monto); }, 0)) + '</td>' +
                  '<td colspan="2"></td>' +
                '</tr>' +
              '</tfoot>' +
            '</table>' +
          '</div>' +
        '</div>' 
      : ''}

      <!-- Gastos del Período -->
      ${gastos && gastos.length > 0 ? 
        '<div class="mb-4">' +
          '<h4 class="text-md font-semibold text-gray-700 mb-4">Gastos del Período</h4>' +
          '<div class="overflow-x-auto">' +
            '<table class="w-full text-sm">' +
              '<thead class="bg-gray-50">' +
                '<tr>' +
                  '<th class="px-4 py-2 text-left text-gray-600">Fecha</th>' +
                  '<th class="px-4 py-2 text-left text-gray-600">Motivo</th>' +
                  '<th class="px-4 py-2 text-left text-gray-600">Método</th>' +
                  '<th class="px-4 py-2 text-right text-gray-600">Monto</th>' +
                  '<th class="px-4 py-2 text-left text-gray-600">Registrado por</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody class="divide-y divide-gray-100">' +
                gastos.map(function(g) {
                  return '<tr>' +
                    '<td class="px-4 py-2 text-gray-600">' + moment(g.createdAt).tz(config.timezone).format('DD/MM/YYYY HH:mm') + '</td>' +
                    '<td class="px-4 py-2 text-gray-800">' + g.motivo + '</td>' +
                    '<td class="px-4 py-2"><span class="px-2 py-1 rounded-full text-xs ' + 
                      (g.metodoPago === 'efectivo' ? 'bg-green-100 text-green-700' : 
                       g.metodoPago === 'tarjeta' ? 'bg-blue-100 text-blue-700' : 
                       'bg-purple-100 text-purple-700') + '">' + g.metodoPago + '</span></td>' +
                    '<td class="px-4 py-2 text-right font-semibold text-red-600">' + formatCurrency(g.monto) + '</td>' +
                    '<td class="px-4 py-2 text-gray-600">' + (g.usuario ? g.usuario.nombre : 'Sistema') + '</td>' +
                  '</tr>';
                }).join('') +
              '</tbody>' +
              '<tfoot class="bg-gray-50">' +
                '<tr>' +
                  '<td colspan="3" class="px-4 py-2 text-right font-semibold text-gray-700">Total de Gastos:</td>' +
                  '<td class="px-4 py-2 text-right font-bold text-red-600">' + formatCurrency(gastos.reduce(function(sum, g) { return sum + parseFloat(g.monto); }, 0)) + '</td>' +
                  '<td></td>' +
                '</tr>' +
              '</tfoot>' +
            '</table>' +
          '</div>' +
        '</div>' 
      : (retiros && retiros.length > 0 || (pagosLaboratorios && pagosLaboratorios.length > 0) ? '' : '<div class="text-center text-gray-500 py-4">No hay gastos registrados en este período</div>')}
    </div>

    <!-- Formulario de corte -->
    <form id="formCorte" onsubmit="procesarCorte(event)" class="bg-gray-50 rounded-lg p-6">
      ${tipoCorte === 'efectivo' ? 
        '<div class="mb-4">' +
          '<label class="block text-sm font-medium text-gray-700 mb-2">' +
            'Saldo Final en Efectivo ($)' +
          '</label>' +
          '<input type="number" id="saldoFinal" step="0.01" min="0" required ' +
                 'class="w-full px-4 py-3 border border-gray-300 rounded-lg text-2xl font-bold text-center focus:ring-2 focus:ring-primary-500 focus:border-transparent" ' +
                 'placeholder="0.00" autofocus value="' + (resumen.saldoEsperado === 0 ? '0' : '') + '" autocomplete="off">' +
          '<p class="text-xs text-gray-500 mt-1">Ingresa el saldo real contado en efectivo</p>' +
        '</div>' 
      : tipoCorte === 'bancos' ? 
        '<div class="grid md:grid-cols-3 gap-4 mb-4">' +
          '<div>' +
            '<label class="block text-sm font-medium text-gray-700 mb-2">' +
              'Saldo Final Azteca ($)' +
            '</label>' +
            '<input type="number" id="saldoFinalAzteca" step="0.01" min="0" required ' +
                   'class="w-full px-4 py-3 border border-gray-300 rounded-lg text-xl font-bold text-center focus:ring-2 focus:ring-green-500 focus:border-transparent" ' +
                   'placeholder="0.00" autofocus value="" autocomplete="off">' +
          '</div>' +
          '<div>' +
            '<label class="block text-sm font-medium text-gray-700 mb-2">' +
              'Saldo Final BBVA ($)' +
            '</label>' +
            '<input type="number" id="saldoFinalBbva" step="0.01" min="0" required ' +
                   'class="w-full px-4 py-3 border border-gray-300 rounded-lg text-xl font-bold text-center focus:ring-2 focus:ring-blue-500 focus:border-transparent" ' +
                   'placeholder="0.00" value="" autocomplete="off">' +
          '</div>' +
          '<div>' +
            '<label class="block text-sm font-medium text-gray-700 mb-2">' +
              'Saldo Final Mercado Pago ($)' +
            '</label>' +
            '<input type="number" id="saldoFinalMp" step="0.01" min="0" required ' +
                   'class="w-full px-4 py-3 border border-gray-300 rounded-lg text-xl font-bold text-center focus:ring-2 focus:ring-indigo-500 focus:border-transparent" ' +
                   'placeholder="0.00" value="" autocomplete="off">' +
          '</div>' +
        '</div>' 
      : 
        '<div class="mb-4">' +
          '<label class="block text-sm font-medium text-gray-700 mb-2">' +
            'Saldo Final en Caja ($)' +
          '</label>' +
          '<input type="number" id="saldoFinal" step="0.01" min="0" required ' +
                 'class="w-full px-4 py-3 border border-gray-300 rounded-lg text-2xl font-bold text-center focus:ring-2 focus:ring-primary-500 focus:border-transparent" ' +
                 'placeholder="0.00" autofocus value="' + (resumen.saldoEsperado === 0 ? '0' : '') + '" autocomplete="off">' +
          '<p class="text-xs text-gray-500 mt-1">Ingresa el saldo real contado en caja</p>' +
        '</div>'
      }

      <div id="diferenciaContainer" class="mb-4 hidden">
        <div class="p-3 rounded-lg" id="diferenciaBox">
          <p class="text-sm font-medium mb-1">Diferencia</p>
          <p class="text-xl font-bold" id="diferenciaTexto"></p>
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Observaciones (opcional)
        </label>
        <textarea id="observaciones" rows="3" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                  placeholder="Notas sobre el corte..."></textarea>
      </div>

      <div class="flex gap-4">
        <button type="button" onclick="window.location.href='/pos'" 
                class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition font-medium">
          Cancelar
        </button>
        <button type="submit" 
                class="flex-1 bg-primary-600 text-white py-3 rounded-lg hover:bg-primary-700 transition font-medium">
          <i class="fas fa-check mr-2"></i> Confirmar Corte
        </button>
      </div>
    </form>

    <!-- Lista de ventas -->
    ${ventas.length > 0 ? 
      '<div class="mt-6 bg-white rounded-xl shadow-sm p-6">' +
        '<h3 class="text-lg font-bold text-gray-800 mb-4">Ventas del Período</h3>' +
        '<div class="overflow-x-auto">' +
          '<table class="w-full text-sm">' +
            '<thead class="bg-gray-50">' +
              '<tr>' +
                '<th class="px-4 py-2 text-left text-gray-600">Folio</th>' +
                '<th class="px-4 py-2 text-left text-gray-600">Paciente</th>' +
                '<th class="px-4 py-2 text-left text-gray-600">Método</th>' +
                '<th class="px-4 py-2 text-right text-gray-600">Total</th>' +
                '<th class="px-4 py-2 text-left text-gray-600">Hora</th>' +
              '</tr>' +
            '</thead>' +
            '<tbody class="divide-y divide-gray-100">' +
              ventas.map(function(v) {
                return '<tr>' +
                  '<td class="px-4 py-2 font-mono text-gray-800">' + v.folio + '</td>' +
                  '<td class="px-4 py-2 text-gray-600">' + (v.paciente ? v.paciente.nombre + ' ' + v.paciente.apellido : 'Cliente general') + '</td>' +
                  '<td class="px-4 py-2"><span class="px-2 py-1 rounded-full text-xs ' + 
                    (v.metodoPago === 'efectivo' ? 'bg-green-100 text-green-700' : 
                     v.metodoPago === 'tarjeta' ? 'bg-blue-100 text-blue-700' : 
                     'bg-purple-100 text-purple-700') + '">' + v.metodoPago + '</span></td>' +
                  '<td class="px-4 py-2 text-right font-bold text-gray-800">' + formatCurrency(v.total) + ' <span class="text-xs text-gray-500">' + (v.moneda || 'MXN') + '</span></td>' +
                  '<td class="px-4 py-2 text-gray-500">' + moment(v.createdAt).tz(config.timezone).format('HH:mm') + '</td>' +
                '</tr>';
              }).join('') +
            '</tbody>' +
          '</table>' +
        '</div>' +
      '</div>' 
    : ''}
  </div>
</div>
`}) %>

<script>
function procesarCorte(event) {
  event.preventDefault();
  const observaciones = document.getElementById('observaciones').value;
  const tipoCorte = <%- tipoCorteJson %>;
  
  let url = <%- urlStrJson %>;
  let body = {
    hora: <%- horaStrJson %>,
    observaciones: observaciones
  };
  
  if (tipoCorte === 'efectivo') {
    const saldoFinalInput = document.getElementById('saldoFinal');
    const saldoEsperado = <%- saldoEsperadoJson %>;
    let saldoFinal = parseFloat(saldoFinalInput.value);
    
    // Si el campo está vacío y el saldo esperado es 0, establecer en 0
    if (isNaN(saldoFinal) || saldoFinalInput.value.trim() === '') {
      if (saldoEsperado === 0) {
        saldoFinal = 0;
      } else {
        mostrarNotificacion('error', 'Error', 'Saldo final requerido y debe ser un número válido');
        return;
      }
    }
    
    // Permitir 0 siempre (especialmente cuando el saldo esperado es 0)
    if (saldoFinal < 0) {
      mostrarNotificacion('error', 'Error', 'El saldo final no puede ser negativo');
      return;
    }
    
    url = '/pos/corte-efectivo';
    body.saldoFinal = saldoFinal;
  } else if (tipoCorte === 'bancos') {
    const saldoFinalAzteca = parseFloat(document.getElementById('saldoFinalAzteca').value);
    const saldoFinalBbva = parseFloat(document.getElementById('saldoFinalBbva').value);
    const saldoFinalMp = parseFloat(document.getElementById('saldoFinalMp').value);
    
    if (isNaN(saldoFinalAzteca) || saldoFinalAzteca < 0) {
      mostrarNotificacion('error', 'Error', 'Ingresa un saldo final válido para Azteca');
      return;
    }
    if (isNaN(saldoFinalBbva) || saldoFinalBbva < 0) {
      mostrarNotificacion('error', 'Error', 'Ingresa un saldo final válido para BBVA');
      return;
    }
    if (isNaN(saldoFinalMp) || saldoFinalMp < 0) {
      mostrarNotificacion('error', 'Error', 'Ingresa un saldo final válido para Mercado Pago');
      return;
    }
    
    url = '/pos/corte-bancos';
    body.saldoFinalAzteca = saldoFinalAzteca;
    body.saldoFinalBbva = saldoFinalBbva;
    body.saldoFinalMp = saldoFinalMp;
  } else {
    const saldoFinalInput = document.getElementById('saldoFinal');
    const saldoEsperado = <%- saldoEsperadoJson %>;
    let saldoFinal = parseFloat(saldoFinalInput.value);
    
    // Si el campo está vacío y el saldo esperado es 0, establecer en 0
    if (isNaN(saldoFinal) || saldoFinalInput.value.trim() === '') {
      if (saldoEsperado === 0) {
        saldoFinal = 0;
      } else {
        mostrarNotificacion('error', 'Error', 'Saldo final requerido y debe ser un número válido');
        return;
      }
    }
    
    // Permitir 0 siempre (especialmente cuando el saldo esperado es 0)
    if (saldoFinal < 0) {
      mostrarNotificacion('error', 'Error', 'El saldo final no puede ser negativo');
      return;
    }
    
    body.saldoFinal = saldoFinal;
  }

    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    })
  .then(function(response) {
    if (!response.ok) {
      return response.json().then(function(data) {
        throw new Error(data.error || 'Error al procesar el corte');
      });
    }
    return response.json();
  })
  .then(function(result) {
    if (result.success) {
      // Si preguntaRetiro es true y hay saldo de efectivo, preguntar si desea hacer retiro
      if (result.preguntaRetiro && result.saldoFinalEfectivo && parseFloat(result.saldoFinalEfectivo) > 0) {
        preguntarRetiroDespuesCorte(result.saldoFinalEfectivo, result.esFinDia);
      } else {
        // Si no hay saldo de efectivo o no pregunta retiro, ir directamente a saldo inicial
        redirigirASaldoInicial(result.esFinDia);
      }
    } else {
      mostrarNotificacion('error', 'Error', result.error || 'No se pudo procesar el corte');
    }
  })
  .catch(function(error) {
    console.error('Error al procesar corte:', error);
    const mensajeError = error.message || 'No se pudo procesar el corte';
    mostrarNotificacion('error', 'Error', mensajeError);
  });
}

// Limpiar el input al cargar la página
document.addEventListener('DOMContentLoaded', function() {
  const saldoFinalInput = document.getElementById('saldoFinal');
  if (saldoFinalInput) {
    saldoFinalInput.value = '';
    saldoFinalInput.focus();
  }
});

// Calcular diferencia en tiempo real
const tipoCorte = <%- tipoCorteJson %>;
const saldoEsperadoBase = <%- saldoEsperadoJson %>;
if (tipoCorte === 'efectivo') {
  const saldoFinalInput = document.getElementById('saldoFinal');
  if (saldoFinalInput) {
    saldoFinalInput.addEventListener('input', function() {
      const saldoFinal = parseFloat(this.value) || 0;
      const saldoEsperado = parseFloat(saldoEsperadoBase) || 0;
      const diferencia = saldoFinal - saldoEsperado;
      
      const container = document.getElementById('diferenciaContainer');
      const box = document.getElementById('diferenciaBox');
      const texto = document.getElementById('diferenciaTexto');
      
      if (!isNaN(saldoFinal) && saldoFinal > 0) {
        container.classList.remove('hidden');
        if (diferencia === 0) {
          box.className = 'p-3 rounded-lg bg-green-100 border border-green-300';
          texto.className = 'text-xl font-bold text-green-700';
          texto.textContent = 'Cuadra perfecto';
        } else if (diferencia > 0) {
          box.className = 'p-3 rounded-lg bg-blue-100 border border-blue-300';
          texto.className = 'text-xl font-bold text-blue-700';
          texto.textContent = 'Sobrante: ' + diferencia.toFixed(2);
        } else {
          box.className = 'p-3 rounded-lg bg-red-100 border border-red-300';
          texto.className = 'text-xl font-bold text-red-700';
          texto.textContent = 'Faltante: ' + Math.abs(diferencia).toFixed(2);
        }
      } else {
        container.classList.add('hidden');
      }
    });
  }
} else if (tipoCorte !== 'bancos') {
  const saldoFinalInput = document.getElementById('saldoFinal');
  if (saldoFinalInput) {
    saldoFinalInput.addEventListener('input', function() {
      const saldoFinal = parseFloat(this.value) || 0;
      const saldoEsperado = parseFloat(saldoEsperadoBase) || 0;
      const diferencia = saldoFinal - saldoEsperado;
      
      const container = document.getElementById('diferenciaContainer');
      const box = document.getElementById('diferenciaBox');
      const texto = document.getElementById('diferenciaTexto');
      
      if (!isNaN(saldoFinal) && saldoFinal > 0) {
        container.classList.remove('hidden');
        if (diferencia === 0) {
          box.className = 'p-3 rounded-lg bg-green-100 border border-green-300';
          texto.className = 'text-xl font-bold text-green-700';
          texto.textContent = 'Cuadra perfecto';
        } else if (diferencia > 0) {
          box.className = 'p-3 rounded-lg bg-blue-100 border border-blue-300';
          texto.className = 'text-xl font-bold text-blue-700';
          texto.textContent = 'Sobrante: ' + diferencia.toFixed(2);
        } else {
          box.className = 'p-3 rounded-lg bg-red-100 border border-red-300';
          texto.className = 'text-xl font-bold text-red-700';
          texto.textContent = 'Faltante: ' + Math.abs(diferencia).toFixed(2);
        }
      } else {
        container.classList.add('hidden');
      }
    });
  }
}

function mostrarNotificacion(tipo, titulo, mensaje) {
  var existente = document.getElementById('notificacionModal');
  if (existente) existente.remove();

  var iconos = {
    success: '<div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-check text-3xl text-green-500"></i></div>',
    error: '<div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-times text-3xl text-red-500"></i></div>',
  };

  var colores = {
    success: 'bg-green-500 hover:bg-green-600',
    error: 'bg-red-500 hover:bg-red-600',
  };

  var modal = document.createElement('div');
  modal.id = 'notificacionModal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = 
    '<div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full mx-4">' +
      '<div class="p-6 text-center">' +
        iconos[tipo] +
        '<h3 class="text-xl font-bold text-gray-800 mb-2">' + titulo + '</h3>' +
        '<div class="text-gray-600">' + mensaje + '</div>' +
      '</div>' +
      '<div class="px-6 pb-6">' +
        '<button onclick="cerrarNotificacion()" class="w-full ' + colores[tipo] + ' text-white py-3 rounded-xl font-medium">' +
          'Aceptar' +
        '</button>' +
      '</div>' +
    '</div>';

  document.body.appendChild(modal);
}

function cerrarNotificacion() {
  var modal = document.getElementById('notificacionModal');
  if (modal) modal.remove();
}

function mostrarOpcionFinDia() {
  var existente = document.getElementById('notificacionModal');
  if (existente) existente.remove();

  var modal = document.createElement('div');
  modal.id = 'notificacionModal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.style.animation = 'fadeIn 0.2s ease-out';
  modal.innerHTML = 
    '<div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden" style="animation: slideUp 0.3s ease-out">' +
      '<div class="p-6 text-center">' +
        '<div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">' +
          '<i class="fas fa-check text-3xl text-green-500"></i>' +
        '</div>' +
        '<h3 class="text-xl font-bold text-gray-800 mb-2">Corte Realizado</h3>' +
        '<div class="text-gray-600 mb-4">' +
          '<p>El corte de caja se ha registrado correctamente.</p>' +
          '<p class="mt-2 font-medium">¿Deseas cerrar las operaciones del día?</p>' +
        '</div>' +
      '</div>' +
      '<div class="px-6 pb-6 space-y-3">' +
        '<button onclick="cerrarDia()" class="w-full bg-primary-600 text-white py-3 rounded-xl font-medium transition transform hover:scale-105">' +
          '<i class="fas fa-door-open mr-2"></i> Cerrar Día' +
        '</button>' +
        '<button onclick="continuarOperaciones()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-medium transition">' +
          'Continuar Operaciones' +
        '</button>' +
      '</div>' +
    '</div>';

  document.body.appendChild(modal);
}

function cerrarDia() {
  cerrarNotificacion();
  mostrarNotificacion('success', 'Día Cerrado', 
    '<p>Las operaciones del día han sido cerradas.</p>' +
    '<p class="mt-2 text-sm text-gray-600">Al siguiente inicio de sesión se solicitará el saldo inicial...</p>'
  );
  setTimeout(function() {
    window.location.href = '/pos?necesitaSaldoInicial=true';
  }, 2000);
}

function continuarOperaciones() {
  cerrarNotificacion();
  // Después de cualquier corte, solicitar saldo inicial
  mostrarNotificacion('info', 'Saldo Inicial Requerido', 
    '<p>Debes ingresar el saldo inicial para continuar con las operaciones.</p>'
  );
  setTimeout(function() {
    window.location.href = '/pos?necesitaSaldoInicial=true';
  }, 2000);
}

function preguntarRetiroDespuesCorte(saldoFinalEfectivo, esFinDia) {
  var existente = document.getElementById('notificacionModal');
  if (existente) existente.remove();

  var modal = document.createElement('div');
  modal.id = 'notificacionModal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.style.animation = 'fadeIn 0.2s ease-out';
  modal.innerHTML = 
    '<div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden" style="animation: slideUp 0.3s ease-out">' +
      '<div class="p-6 text-center">' +
        '<div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">' +
          '<i class="fas fa-money-bill-wave text-3xl text-blue-500"></i>' +
        '</div>' +
        '<h3 class="text-xl font-bold text-gray-800 mb-2">Saldo Disponible en Efectivo</h3>' +
        '<div class="text-gray-600 mb-4">' +
          '<p class="text-2xl font-bold text-primary-600 mb-2">$' + parseFloat(saldoFinalEfectivo).toFixed(2) + '</p>' +
          '<p class="mt-2 font-medium">¿Deseas retirar efectivo de la caja?</p>' +
        '</div>' +
      '</div>' +
      '<div class="px-6 pb-6 space-y-3">' +
        '<button onclick="irARetiro()" class="w-full bg-primary-600 text-white py-3 rounded-xl font-medium transition transform hover:scale-105">' +
          '<i class="fas fa-hand-holding-usd mr-2"></i> Realizar Retiro' +
        '</button>' +
        '<button onclick="redirigirASaldoInicial(' + (esFinDia ? 'true' : 'false') + ')" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-medium transition">' +
          'Continuar sin Retirar' +
        '</button>' +
      '</div>' +
    '</div>';

  document.body.appendChild(modal);
}

function irARetiro() {
  cerrarNotificacion();
  window.location.href = '/retiros';
}

function redirigirASaldoInicial(esFinDia) {
  cerrarNotificacion();
  if (esFinDia) {
    mostrarOpcionFinDia();
  } else {
    mostrarNotificacion('info', 'Saldo Inicial Requerido', 
      '<p>Debes ingresar el saldo inicial para continuar con las operaciones.</p>'
    );
    setTimeout(function() {
      window.location.href = '/pos?necesitaSaldoInicial=true';
    }, 2000);
  }
}
</script>

