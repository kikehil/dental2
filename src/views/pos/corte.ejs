<% const tCorte=typeof tipoCorte !=='undefined' ? tipoCorte : "" ; const sEsp=(typeof resumen !=='undefined' &&
  resumen.saldoEsperado) ? resumen.saldoEsperado : 0; const sEspAzteca=(typeof resumen !=='undefined' &&
  resumen.saldoEsperadoAzteca) ? resumen.saldoEsperadoAzteca : 0; const sEspBbva=(typeof resumen !=='undefined' &&
  resumen.saldoEsperadoBbva) ? resumen.saldoEsperadoBbva : 0; const sEspMp=(typeof resumen !=='undefined' &&
  resumen.saldoEsperadoMp) ? resumen.saldoEsperadoMp : 0; const sIniEfectivo=(typeof resumen !=='undefined' &&
  resumen.saldoInicialEfectivo) ? resumen.saldoInicialEfectivo : 0; const vEfectivo=(typeof resumen !=='undefined' &&
  resumen.ventasEfectivo) ? resumen.ventasEfectivo : 0; // Construir el contenido HTML en una variable para el layout
  let content=` <div class="max-w-4xl mx-auto">
  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">`;
          if (tCorte === 'efectivo') {
          content += `<i class="fas fa-money-bill-wave text-green-500 mr-2"></i>Corte de Efectivo`;
          } else if (tCorte === 'bancos') {
          content += `<i class="fas fa-university text-blue-500 mr-2"></i>Corte de Bancos`;
          } else {
          content += `<i class="fas fa-cut text-primary-500 mr-2"></i>Corte de Caja`;
          }
          content += `</h2>
        <p class="text-gray-600">${moment().tz(config.timezone).format('DD/MM/YYYY HH:mm')}</p>
      </div>
      <a href="/pos" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-2xl"></i></a>
    </div>`;

    if (tCorte === 'efectivo') {
    content += `
    <div class="grid md:grid-cols-2 gap-4 mb-6">
      <div class="bg-primary-50 rounded-lg p-4 border-l-4 border-primary-500">
        <p class="text-sm text-gray-600 mb-1">Saldo Inicial Efectivo</p>
        <p class="text-2xl font-bold text-primary-600">${formatCurrency(sIniEfectivo)}</p>
      </div>
      <div class="bg-secondary-50 rounded-lg p-4 border-l-4 border-secondary-500">
        <p class="text-sm text-gray-600 mb-1">Total Ventas en Efectivo</p>
        <p class="text-2xl font-bold text-secondary-600">${formatCurrency(vEfectivo)}</p>
      </div>
    </div>
    <div class="bg-amber-50 rounded-lg p-4 mb-6 border-l-4 border-amber-500">
      <p class="text-sm text-gray-600 mb-1">Saldo Esperado en Caja</p>
      <p class="text-3xl font-bold text-amber-600">${formatCurrency(sEsp)}</p>
    </div>`;
    } else if (tCorte === 'bancos') {
    content += `
    <div class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
        <p class="text-xs text-gray-600 mb-1">Esperado Azteca</p>
        <p class="text-xl font-bold text-blue-700">${formatCurrency(sEspAzteca)}</p>
      </div>
      <div class="bg-indigo-50 rounded-lg p-4 border-l-4 border-indigo-500">
        <p class="text-xs text-gray-600 mb-1">Esperado BBVA</p>
        <p class="text-xl font-bold text-indigo-700">${formatCurrency(sEspBbva)}</p>
      </div>
      <div class="bg-purple-50 rounded-lg p-4 border-l-4 border-purple-500">
        <p class="text-xs text-gray-600 mb-1">Esperado Mercado Pago</p>
        <p class="text-xl font-bold text-purple-700">${formatCurrency(sEspMp)}</p>
      </div>
    </div>`;
    }

    content += `
    <form id="formCorte" onsubmit="procesarCorte(event)" class="bg-gray-50 rounded-lg p-6">`;
      if (tCorte === 'bancos') {
      content += `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Saldo Azteca ($)</label>
          <input type="number" id="saldoAzteca" step="0.01" min="0" required value="${sEspAzteca.toFixed(2)}"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg text-lg font-bold text-center">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Saldo BBVA ($)</label>
          <input type="number" id="saldoBbva" step="0.01" min="0" required value="${sEspBbva.toFixed(2)}"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg text-lg font-bold text-center">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Saldo MP ($)</label>
          <input type="number" id="saldoMp" step="0.01" min="0" required value="${sEspMp.toFixed(2)}"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg text-lg font-bold text-center">
        </div>
      </div>`;
      } else {
      content += `
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Saldo Final en Efectivo ($)</label>
        <input type="number" id="saldoFinal" step="0.01" min="0" required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg text-2xl font-bold text-center" placeholder="0.00"
          autofocus autocomplete="off">
      </div>`;
      }

      content += `
      <div id="diferenciaContainer" class="mb-4 hidden">
        <div class="p-3 rounded-lg" id="diferenciaBox">
          <p class="text-sm font-medium mb-1">Diferencia</p>
          <p class="text-xl font-bold" id="diferenciaTexto"></p>
        </div>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Observaciones</label>
        <textarea id="observaciones" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
      </div>
      <div class="flex gap-4 pt-4">
        <button type="button" onclick="window.location.href='/pos'"
          class="flex-1 bg-gray-200 py-3 rounded-lg font-medium">Cancelar</button>
        <button type="submit"
          class="flex-1 bg-primary-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-primary-700 transition">
          Confirmar Corte
        </button>
      </div>
    </form>
  </div>
  </div>

  <script>
    function procesarCorte(event) {
      event.preventDefault();
      const obs = document.getElementById('observaciones').value;
      const tCorte = "${tCorte}";
      let data = { hora: "${hora || ""}", observaciones: obs };
      let url = "/pos/corte-efectivo";

      if (tCorte === "bancos") {
        url = "/pos/corte-bancos";
        data.saldoFinalAzteca = parseFloat(document.getElementById('saldoAzteca').value || 0);
        data.saldoFinalBbva = parseFloat(document.getElementById('saldoBbva').value || 0);
        data.saldoFinalMp = parseFloat(document.getElementById('saldoMp').value || 0);
      } else {
        data.saldoFinal = parseFloat(document.getElementById('saldoFinal').value || 0);
      }

      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(r => r.json())
        .then(res => {
          if (res.success) {
            if (res.requiereSaldoInicial) {
              window.location.href = '/pos?necesitaSaldoInicial=true';
            } else {
              window.location.href = '/pos';
            }
          } else {
            alert(res.error || 'Error al procesar el corte');
          }
        });
    }

    const inputEf = document.getElementById('saldoFinal');
    if (inputEf) {
      inputEf.addEventListener('input', e => {
        const val = parseFloat(e.target.value) || 0;
        const sEspTotal = ${ sEsp };
        const dif = val - sEspTotal;
        const cont = document.getElementById('diferenciaContainer');
        const txt = document.getElementById('diferenciaTexto');
        const box = document.getElementById('diferenciaBox');
        cont.classList.remove('hidden');
        if (Math.abs(dif) < 0.01) {
          box.className = 'p-3 rounded-lg bg-green-100 border border-green-300';
          txt.textContent = 'Cuadra perfecto';
        } else {
          box.className = dif > 0 ? 'p-3 rounded-lg bg-blue-100 border border-blue-300' : 'p-3 rounded-lg bg-red-100 border border-red-300';
          txt.textContent = (dif > 0 ? 'Sobrante: ' : 'Faltante: ') + Math.abs(dif).toFixed(2);
        }
      });
    }
  </script>`;
  %>
  <%- include('../layout', { body: content }) %>