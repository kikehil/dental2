<% const tCorte=tipoCorte || "" ; const sEsp=(resumen && resumen.saldoEsperado) || 0; let body="" ; body +=`<div
  class="max-w-4xl mx-auto">
  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">`;

          if (tCorte === 'efectivo') {
          body += `<i class="fas fa-money-bill-wave text-green-500 mr-2"></i>Corte de Efectivo`;
          } else if (tCorte === 'bancos') {
          body += `<i class="fas fa-university text-blue-500 mr-2"></i>Corte de Bancos`;
          } else {
          body += `Corte de Caja`;
          }

          body += `</h2>
        <p class="text-gray-600">${moment().tz(config.timezone).format('DD/MM/YYYY HH:mm')}</p>
      </div>
      <a href="/pos" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-2xl"></i></a>
    </div>`;

    if (tCorte === 'efectivo') {
    body += `<div class="grid md:grid-cols-2 gap-4 mb-6">
      <div class="bg-primary-50 rounded-lg p-4 border-l-4 border-primary-500">
        <p class="text-sm text-gray-600 mb-1">Saldo Inicial Efectivo</p>
        <p class="text-2xl font-bold text-primary-600">${formatCurrency(resumen.saldoInicialEfectivo)}</p>
      </div>
      <div class="bg-secondary-50 rounded-lg p-4 border-l-4 border-secondary-500">
        <p class="text-sm text-gray-600 mb-1">Total Ventas en Efectivo</p>
        <p class="text-2xl font-bold text-secondary-600">${formatCurrency(resumen.ventasEfectivo)}</p>
      </div>
    </div>
    <div class="bg-amber-50 rounded-lg p-4 mb-6 border-l-4 border-amber-500">
      <p class="text-sm text-gray-600 mb-1">Saldo Esperado en Caja</p>
      <p class="text-3xl font-bold text-amber-600">${formatCurrency(resumen.saldoEsperado)}</p>
    </div>`;
    }

    body += `<form id="formCorte" onsubmit="procesarCorte(event)" class="bg-gray-50 rounded-lg p-6">
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Saldo Final en Efectivo ($)</label>
        <input type="number" id="saldoFinal" step="0.01" min="0" required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg text-2xl font-bold text-center" placeholder="0.00"
          autofocus autocomplete="off">
      </div>
      <div id="diferenciaContainer" class="mb-4 hidden">
        <div class="p-3 rounded-lg" id="diferenciaBox">
          <p class="text-sm font-medium mb-1">Diferencia</p>
          <p class="text-xl font-bold" id="diferenciaTexto"></p>
        </div>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Observaciones</label>
        <textarea id="observaciones" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
      </div>
      <div class="flex gap-4">
        <button type="button" onclick="window.location.href='/pos'"
          class="flex-1 bg-gray-200 py-3 rounded-lg">Cancelar</button>
        <button type="submit" class="flex-1 bg-primary-600 text-white py-3 rounded-lg font-medium">Confirmar
          Corte</button>
      </div>
    </form>
  </div>
  </div>
  <script>
    function procesarCorte(event) {
      event.preventDefault();
      const obs = document.getElementById('observaciones').value;
      const sf = parseFloat(document.getElementById('saldoFinal').value);
      fetch('/pos/corte-efectivo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hora: '${hora || ""}', saldoFinal: sf, observaciones: obs })
      }).then(r => r.json()).then(res => {
        if (res.success) window.location.href = '/pos?necesitaSaldoInicial=true';
        else alert(res.error || 'Error');
      });
    }
    const inputEf = document.getElementById('saldoFinal');
    if (inputEf) {
      inputEf.addEventListener('input', e => {
        const val = parseFloat(e.target.value) || 0;
        const dif = val - ${ sEsp };
        const cont = document.getElementById('diferenciaContainer');
        const txt = document.getElementById('diferenciaTexto');
        const box = document.getElementById('diferenciaBox');
        cont.classList.remove('hidden');
        if (dif === 0) {
          box.className = 'p-3 rounded-lg bg-green-100 border border-green-300';
          txt.textContent = 'Cuadra perfecto';
        } else {
          box.className = dif > 0 ? 'p-3 rounded-lg bg-blue-100 border border-blue-300' : 'p-3 rounded-lg bg-red-100 border border-red-300';
          txt.textContent = (dif > 0 ? 'Sobrante: ' : 'Faltante: ') + Math.abs(dif).toFixed(2);
        }
      });
    }
  </script>`;
  %>
  <%- include('../layout', { body: body }) %>