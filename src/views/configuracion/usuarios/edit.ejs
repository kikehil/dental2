<% // Preparar variables JSON antes del include para evitar problemas de parsing const
  doctoresDataJsonStr=JSON.stringify((doctores || []).map(function(d) { return { id: d.id, text: d.nombre + ' ' +
  d.apellido }; })); const usuarioDoctorIdStr=usuario.doctorId || 'null' ; %>
  <%- include('../../layout', { body: ` <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-900">
          <i class="fas fa-user-edit mr-3 text-primary-500"></i>
          Editar Usuario
        </h1>
        <a href="/configuracion/usuarios" class="text-gray-600 hover:text-gray-900">
          <i class="fas fa-arrow-left mr-2"></i>Volver
        </a>
      </div>

      ` + (error ? `
      <div class="mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
        ` + error + `
      </div>
      ` : '') + `

      <form action="/configuracion/usuarios/<%= usuario.id %>/update" method="POST" class="space-y-6">
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Nombre -->
          <div>
            <label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">
              Nombre Completo <span class="text-red-500">*</span>
            </label>
            <input type="text" id="nombre" name="nombre" value="<%= usuario.nombre %>" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              Email <span class="text-red-500">*</span>
            </label>
            <input type="email" id="email" name="email" value="<%= usuario.email %>" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
          </div>

          <!-- Contraseña -->
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
              Nueva Contraseña (dejar vacío para mantener la actual)
            </label>
            <input type="password" id="password" name="password"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              placeholder="••••••••">
          </div>

          <!-- Rol -->
          <div>
            <label for="rol" class="block text-sm font-medium text-gray-700 mb-2">
              Rol <span class="text-red-500">*</span>
            </label>
            <select id="rol" name="rol" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
              <option value="recepcionista" <%=usuario.rol==='recepcionista' ? 'selected' : '' %>>Recepcionista</option>
              <option value="doctor" <%=usuario.rol==='doctor' ? 'selected' : '' %>>Doctor</option>
              <option value="admin" <%=usuario.rol==='admin' ? 'selected' : '' %>>Administrador</option>
            </select>
          </div>

          <!-- Doctor (opcional) -->
          <div>
            <label for="doctorId" class="block text-sm font-medium text-gray-700 mb-2">
              Doctor (Opcional)
            </label>
            <input type="hidden" id="doctorId" name="doctorId">
            <input type="text" id="doctorId_search"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              placeholder="Buscar doctor..." autocomplete="off">
          </div>

          <!-- Estado -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Estado
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="activo" <%=usuario.activo ? 'checked' : '' %>
              class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
              <span class="ml-2 text-sm text-gray-700">Usuario activo</span>
            </label>
          </div>
        </div>

        <!-- Módulos -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">
            Módulos con Acceso
          </label>
          <div class="grid md:grid-cols-2 gap-3 p-4 bg-gray-50 rounded-lg">
            ` + (modulos && modulos.length > 0 ? modulos.map(modulo => {
            const tieneAcceso = usuario.permisos.some(p => p.moduloId === modulo.id && p.acceso);
            return `
            <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
              <input type="checkbox" name="modulos[]" value="<%= modulo.id %>" <%=tieneAcceso ? 'checked' : '' %>
              class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
              <span class="ml-3 text-sm text-gray-700">
                <i class="<%= modulo.icono || 'fas fa-folder' %> mr-2"></i>
                <%= modulo.nombre %>
              </span>
            </label>
            `;
            }).join('') : '<p class="text-sm text-gray-500">No hay módulos disponibles</p>') + `
          </div>
        </div>

        <!-- Botones -->
        <div class="flex justify-end gap-3 pt-4 border-t">
          <a href="/configuracion/usuarios"
            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
            Cancelar
          </a>
          <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">
            <i class="fas fa-save mr-2"></i>Actualizar Usuario
          </button>
        </div>
      </form>
    </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const doctoresData = <%= doctoresDataJsonStr %>;
        const usuarioDoctorId = <%= usuarioDoctorIdStr %>;

        const doctorSelect = createSearchableSelect({
          inputId: 'doctorId_search',
          hiddenInputId: 'doctorId',
          options: doctoresData,
          placeholder: 'Buscar doctor...',
          emptyText: 'No se encontraron doctores'
        });

        // Establecer valor inicial si hay un doctor asignado
        if (usuarioDoctorId) {
          doctorSelect.setValue(usuarioDoctorId);
        }
      });
    </script>
    ` }) %>