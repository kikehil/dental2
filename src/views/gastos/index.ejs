<%- include('../layout', { body: `
<div class="max-w-6xl mx-auto">
  <!-- Pestañas -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <div class="border-b border-gray-200 mb-6">
      <nav class="flex space-x-8">
        <a href="/gastos" class="px-4 py-2 border-b-2 ${tab === 'general' || !tab ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700'} font-medium">
          Gastos Generales
        </a>
        <a href="/gastos/laboratorio" class="px-4 py-2 border-b-2 ${tab === 'laboratorio' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700'} font-medium">
          <i class="fas fa-flask mr-2"></i>Pagos a Laboratorios
        </a>
        <a href="/gastos/prestamos" class="px-4 py-2 border-b-2 ${tab === 'prestamos' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700'} font-medium">
          <i class="fas fa-hand-holding-usd mr-2"></i>Préstamos al Personal
        </a>
      </nav>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <div class="flex justify-end items-center mb-6">
      <div class="flex gap-2">
        ${tab === 'laboratorio' ? 
          '<a href="/gastos/laboratorio/crear" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg">' +
            '<i class="fas fa-plus mr-2"></i>Registrar Pago a Laboratorio' +
          '</a>' :
          '<a href="/gastos/crear" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg">' +
            '<i class="fas fa-plus mr-2"></i>Registrar Gasto' +
          '</a>'
        }
        <a href="/gastos/reporte?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}" target="_blank" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
          <i class="fas fa-file-pdf mr-2"></i>Reporte PDF
        </a>
      </div>
    </div>

    ${success ? '<div class="mb-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">' + success + '</div>' : ''}

    ${error ? '<div class="mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">' + error + '</div>' : ''}

    <div class="mb-6">
      <form method="GET" action="/gastos" class="flex gap-2">
        <input type="date" name="fechaInicio" value="${fechaInicio}" class="px-4 py-2 border rounded-lg">
        <input type="date" name="fechaFin" value="${fechaFin}" class="px-4 py-2 border rounded-lg">
        <button type="submit" class="bg-primary-500 hover:bg-primary-600 text-white px-6 py-2 rounded-lg">
          <i class="fas fa-search mr-2"></i>Buscar
        </button>
        <a href="/gastos" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
          <i class="fas fa-redo mr-2"></i>Limpiar
        </a>
      </form>
    </div>

    <div class="grid md:grid-cols-4 gap-4 mb-6">
      <div class="bg-red-50 rounded-lg p-4 border-l-4 border-red-500">
        <p class="text-sm text-gray-600 mb-1">Total Gastos</p>
        <p class="text-2xl font-bold text-red-600">${formatCurrency(totalGastos)}</p>
      </div>
      <div class="bg-green-50 rounded-lg p-4 border-l-4 border-green-500">
        <p class="text-sm text-gray-600 mb-1">Efectivo</p>
        <p class="text-xl font-bold text-green-600">${formatCurrency(totalPorMetodo.efectivo)}</p>
      </div>
      <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
        <p class="text-sm text-gray-600 mb-1">Tarjeta</p>
        <p class="text-xl font-bold text-blue-600">${formatCurrency(totalPorMetodo.tarjeta)}</p>
      </div>
      <div class="bg-purple-50 rounded-lg p-4 border-l-4 border-purple-500">
        <p class="text-sm text-gray-600 mb-1">Transferencia</p>
        <p class="text-xl font-bold text-purple-600">${formatCurrency(totalPorMetodo.transferencia)}</p>
      </div>
    </div>

    <!-- Desglose detallado por método y banco -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Desglose por Método de Pago y Banco</h2>
      
      <div class="grid md:grid-cols-3 gap-6">
        <!-- Efectivo -->
        <div class="border rounded-lg p-4">
          <h3 class="text-lg font-semibold text-green-700 mb-3 flex items-center">
            <i class="fas fa-money-bill-wave mr-2"></i>Efectivo
          </h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center py-2 border-b">
              <span class="text-gray-600">Total</span>
              <span class="text-lg font-bold text-green-600">${formatCurrency(totalPorMetodoYBanco.efectivo.total)}</span>
            </div>
          </div>
        </div>

        <!-- Tarjeta -->
        <div class="border rounded-lg p-4">
          <h3 class="text-lg font-semibold text-blue-700 mb-3 flex items-center">
            <i class="fas fa-credit-card mr-2"></i>Tarjeta
          </h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center py-1">
              <span class="text-sm text-gray-600">Azteca</span>
              <span class="text-sm font-semibold text-gray-800">${formatCurrency(totalPorMetodoYBanco.tarjeta.desglose['Azteca'] || 0)}</span>
            </div>
            <div class="flex justify-between items-center py-1">
              <span class="text-sm text-gray-600">BBVA</span>
              <span class="text-sm font-semibold text-gray-800">${formatCurrency(totalPorMetodoYBanco.tarjeta.desglose['BBVA'] || 0)}</span>
            </div>
            <div class="flex justify-between items-center py-1">
              <span class="text-sm text-gray-600">Mercado Pago</span>
              <span class="text-sm font-semibold text-gray-800">${formatCurrency(totalPorMetodoYBanco.tarjeta.desglose['Mercado Pago'] || 0)}</span>
            </div>
            <div class="flex justify-between items-center py-2 border-t mt-2 pt-2">
              <span class="font-semibold text-gray-700">Total</span>
              <span class="text-lg font-bold text-blue-600">${formatCurrency(totalPorMetodoYBanco.tarjeta.total)}</span>
            </div>
          </div>
        </div>

        <!-- Transferencia -->
        <div class="border rounded-lg p-4">
          <h3 class="text-lg font-semibold text-purple-700 mb-3 flex items-center">
            <i class="fas fa-exchange-alt mr-2"></i>Transferencia
          </h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center py-1">
              <span class="text-sm text-gray-600">Azteca</span>
              <span class="text-sm font-semibold text-gray-800">${formatCurrency(totalPorMetodoYBanco.transferencia.desglose['Azteca'] || 0)}</span>
            </div>
            <div class="flex justify-between items-center py-1">
              <span class="text-sm text-gray-600">BBVA</span>
              <span class="text-sm font-semibold text-gray-800">${formatCurrency(totalPorMetodoYBanco.transferencia.desglose['BBVA'] || 0)}</span>
            </div>
            <div class="flex justify-between items-center py-1">
              <span class="text-sm text-gray-600">Mercado Pago</span>
              <span class="text-sm font-semibold text-gray-800">${formatCurrency(totalPorMetodoYBanco.transferencia.desglose['Mercado Pago'] || 0)}</span>
            </div>
            <div class="flex justify-between items-center py-2 border-t mt-2 pt-2">
              <span class="font-semibold text-gray-700">Total</span>
              <span class="text-lg font-bold text-purple-600">${formatCurrency(totalPorMetodoYBanco.transferencia.total)}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Motivo</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Método de Pago</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Banco</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuario</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Observaciones</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          ${gastos && gastos.length > 0 ? gastos.map(gasto => 
            '<tr class="hover:bg-gray-50">' +
              '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">' + moment(gasto.createdAt).format('DD/MM/YYYY HH:mm') + '</td>' +
              '<td class="px-4 py-3 text-sm text-gray-900">' + 
                (gasto.tipo === 'laboratorio' && gasto.laboratorio && gasto.paciente ? 
                  '<div>' +
                    '<p class="font-medium">' + gasto.motivo + '</p>' +
                    '<p class="text-xs text-gray-500 mt-1">' +
                      '<i class="fas fa-flask mr-1"></i>' + gasto.laboratorio.nombre + 
                      ' - <i class="fas fa-user mr-1"></i>' + gasto.paciente.nombre + ' ' + gasto.paciente.apellido +
                    '</p>' +
                  '</div>' :
                  gasto.motivo
                ) + 
              '</td>' +
              '<td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-red-600">' + formatCurrency(parseFloat(gasto.monto)) + '</td>' +
              '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 capitalize">' + gasto.metodoPago + 
                (gasto.metodoPago === 'tarjeta' || gasto.metodoPago === 'transferencia' ? 
                  (gasto.banco ? ' <span class="text-xs text-gray-400">(' + gasto.banco + ')</span>' : '') : '') + 
              '</td>' +
              '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">' + 
                (gasto.banco ? '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">' + gasto.banco + '</span>' : 
                 (gasto.metodoPago === 'tarjeta' || gasto.metodoPago === 'transferencia' ? '<span class="text-red-500 text-xs">Sin banco</span>' : '-')) + 
              '</td>' +
              '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">' + (gasto.usuario ? gasto.usuario.nombre : 'N/A') + '</td>' +
              '<td class="px-4 py-3 text-sm text-gray-500">' + (gasto.observaciones || '-') + '</td>' +
            '</tr>'
          ).join('') : '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No se encontraron gastos para el período seleccionado</td></tr>'}
        </tbody>
      </table>
    </div>
  </div>
</div>
` }) %>
